----------------------------------------------------------------------------
--
-- Description :  Mission "Cowboy"
--
--
----------------------------------------------------------------------------


-- Tasks:

------------------------------------ completed ------------ deadline ------------ completed ---------
-- NULL ITTERATION:           |                      |                       |                      |
-- additional models:         |                      |                       |                      |
--     arka                   |    100%              |     22.11.2007        |    22.11.2007        |
--     crane                  |    100%              |     23.11.2007        |    26.11.2007        |
--     shelving               |    100%              |     24.11.2007        |    01.12.2007        |
--     gas bidon              |    100%              |     23.11.2007        |    23.11.2007        |
--     milk bidon             |    100%              |     23.11.2007        |    23.11.2007        |
--     shop art               |    100%              |     27.11.2007        |    27.11.2007        |
--     policy line            |    100%              |     29.11.2007        |    08.12.2007        |
--     lift animation         |    100%              |        <?>            |    08.12.2007        |
----------------------------------------------------------------------------------------------------|
-- FIRST ITTERATION:                                                                                |
-- documentation              |    100%              |     19.11.2007        |    20.11.2007        |
-- vector map                 |    100%              |     19.11.2007        |    19.11.2007        |
-- waypoints                  |    100%              |     19.11.2007        |    19.11.2007        |
-- firepoints                 |    100%              |     19.11.2007        |    19.11.2007        |
-- stairs                     |    100%              |     19.11.2007        |    19.11.2007        |
-- lma triggers               |    100%              |     19.11.2007        |    19.11.2007        |
-- grenade holes              |    100%              |     19.11.2007        |    19.11.2007        |
-- invisible wall             |    100%              |     19.11.2007        |    19.11.2007        |
-- art change                 |    100%              |     21.11.2007        |    24.11.2007        |
-- lg:house under cons-tion   |    100%              |     21.11.2007        |    22.11.2007        |
-- barrel script              |    100%              |     21.11.2007        |    21.11.2007        |
-- lg:outdoor                 |    100%              |     22.11.2007        |    23.11.2007        |
-- lg:house3                  |    100%              |     23.11.2007        |    23.11.2007        |
-- body lifting crane script  |    100%              |     24.11.2007        |    27.11.2007        |
-- kitchen script             |    100%              |     24.11.2007        |    27.11.2007        |
-- lg:first floor             |    100%              |     24.11.2007        |    26.11.2007        |
-- lg:second floor            |    100%              |     24.11.2007        |    26.11.2007        |
-- lg:third floor             |    100%              |     24.11.2007        |    26.11.2007        |
-- physics                    |    100%              |     26.11.2007        |    27.11.2007        |
-- windows                    |    100%              |     26.11.2007        |    27.11.2007        |
-- lg:shop                    |    100%              |     26.11.2007        |    28.11.2007        |
-- milk man script            |    100%              |     26.11.2007        |    28.11.2007        |
-- policeman body script      |    100%              |     27.11.2007   <a>  |    27.11.2007        |
-- benzine and gas reaction   |    100%              |     27.11.2007        |    29.11.2007        |
-- search script              |    100% [100%]       |     27.11.2007        |    28.11.2007        |
-- npc postprocess            |    100% [70%]        |     27.11.2007        |    28.11.2007        |
-- zone system                |    100% [70%]        |     27.11.2007        |    28.11.2007        |
-- alert script anchor        |    100%              |     28.11.2007        |    03.12.2007        |
-- keys                       |    100%              |     28.11.2007        |    29.11.2007        |
-- stop move messages         |    100% [70%]        |     28.11.2007        |    01.12.2007        |
-- potential physics test     |    100%              |     28.11.2007        |    29.11.2007        |
-- tasks                      |    100%              |     28.11.2007        |    01.12.2007        |
-- marks                      |    100%              |     28.11.2007        |    01.12.2007        |
-- alert setup                |    100%              |     28.11.2007        |    03.12.2007        |
-- alert scripts              |    100% [60%]        |     28.11.2007        |    03.12.2007        |
-- escort scripts             |    100%              |     29.11.2007        |    29.11.2007        |
-- fbi agent. door see        |    100%              |     30.11.2007   <a>  |    03.12.2007        |
-- roof and balcony script    |    100%              |     30.11.2007        |    01.12.2007        |
-- agent script               |    100%              |     30.11.2007        |    01.12.2007        |
-- I it. gameplay test        |    100%              |     30.11.2007   <f>  |    04.12.2007        |
-- policeline door script     |    100%              |     01.12.2007   <a>  |    03.12.2007        |
-- policeline reaction        |    100%              |     01.12.2007   <a>  |    03.12.2007        |
-- dinner script              |    100%              |     01.12.2007   <a>  |    04.12.2007  <~>   |
-- hello spy script           |    100%              |     01.12.2007   <a>  |    01.12.2007        |
-- explosion script           |    100%              |     01.12.2007        |    01.12.2007        |
-- explosion effect           |    100%              |        <?>            |    29.11.2007        |
-- briefing map               |    100%              |        <?>            |    01.12.2007        |
-- grass vision map           |    100%              |        <?>            |    03.12.2007        |
-- waypoint vision level      |      0%              |        <?>            |                      |
-- 
-- lighting                   |      0%              |        <?>            |                      |
-- mirrors                    |      0%              |        <?>            |                      |
-- effects                    |      0%              |        <?>            |                      |
-- help messages              |      0%              |        <?>            |                      |
-- milk man script[use bidon] |    100%              |        <?>            |    05.12.2007        |
-- barrels teleport           |    100%              |        <?>            |                      |
-----------------------------------------------------------------------------------------------------
-- SECOND ITTERATION:
-----------------------------------------------------------------------------------------------------

-- bugs:
-- fbi investigate accident worker body
-- finish cutscene from script. lift animation bug. When high threat
-- testcase:

-- alertgroups:
-- 0 - civilian house3 & outdoor
-- 1 - fbi main house
-- 2 - fbi outdoor
-- 3 - civilian main house
-- 4 - workers
-- 5 - policeman
-- 

--------------------------------- Messages table -----------------------------
  
  MissionText = 
  {
      Task_Rescue                            = " Освободить И. Цавалова";
      Task_Body                              = " Подложить тело";
      Task_Fire                              = " Устроить пожар";
      Task_Leave                             = " Покинуть территорию";
  
      Action_DropBarrels                     = "ТОЛКНУТЬ БОЧКИ";
      Action_DropKitchenCabinet              = "ОПРОКИНУТЬ ШКАФ";
      Action_UseLift                         = "ИСПОЛЬЗОВАТЬ КРАН";
      
      Message_SuitcaseWithExplosion          = "ДИП-Т СО ВЗРЫВЧАТКОЙ";
      
      Message_Move                           = "ИДЕМ";
      Message_Stop                           = "ЖДИ ЗДЕСЬ";
      
      Message_PolicemanTask                  = "@ Здание под нашим контролем. Занимайтесь своими делами.";
      Message_IAmFbi                         = "@ Агент Джонсон. ФБР";
      Message_WhenItWillFinish               = "@ Когда все это закончится?";
      Message_IDontKnow                      = "@ Пока не закончится расследование";
      Message_WhereBarrelsFall               = "@ Бочки сверху упали? ...";
      Message_WhatIdiot                      = "@ Какой идиот, додумался их на край поставить...";
      
      Message_StopMove_Search                = "- Стоять! Я должен обыскать вас!";
      Message_StopMove_Search2               = "- В здание запрещено проносить оружие!";
      
      Message_StopMove_Clean                 = "@ Все чисто - проходи!";
      Message_StopMove_Weapon                = "@ С оружием вход в здание запрещен!";
      Message_StopMove_WeaponSuitcase        = "@ Мне необходимо осмотреть содержимое вашего дипломата..";      
      Message_StopMove_Diplomat              = "@ А что это в дипломате такое? Я не могу пусть вас с этим..";
      Message_StopMove_Strange               = "@ Я не могу вас пустить в здание!";
      
      Message_StopMove_ConstHouse            = "@ В здании небезопасно. Что вам тут нужно?";
      Message_StopMove_Floor1                = "@ Здание под контролем федеральных агентов! Немедленно покиньте его!";
      Message_StopMove_Floor2_MilkMan        = "@ Тебе вроде на кухню надо? На втором этаже ее нет..";
      Message_StopMove_Floor2                = "@ Если вы немедленно не покинете здание, мы откроем огонь!";
      Message_StopMove_Floor3                = "@ Вам нечего тут делать..";
      Message_StopMove_ShopStorage           = "@ Это частная территория! Вы не имеете права находиться здесь!";
      Message_StopMove_ShopStorage_Policeman = "@ Это частная территория! У вас есть ордер?!";
      Message_StopMove_House3_West           = "@ Что вы тут забыли?!";      
      Message_StopMove_Kitchen               = "@ Мне кажется на кухне вам не место!";
      Message_StopMove_Garage                = "@ Что вы тут забыли?!";
      Message_StopMove_Floor2_Sklad          = "@ Что вы тут забыли?!";
      Message_StopMove_BehindMainHouse       = "@ Закрытая зона! Что вам нужно?";
      Message_StopMove_ShopStorageEnter      = "@ Что вам нужно?";
      Message_StopMove_Civilian              = "@ Здание под контролем федеральных агентов! Гражданским вход запрещен!";
      
      Message_StopMove_House3_EastEnter      = "@ Вы не видите, что дверь опечатана? Куда вы идете?";
      Message_StopMove_House3_EastEnter2     = "@ Вы не видите, что это место преступления? Куда вы идете?";
      Message_StopMove_House3_East           = "@ Покиньте место преступления! Или я вынужден буду вас арестовать!";
                  
      Message_FailSpyDied                    = "ЦАВАЛОВ ПОГИБ";
      Message_FailSaySpy                     = "ПОБЕГ РАСКРЫТ";
      Message_FailSpyHit                     = "ПОТЕРЯНА ВОЗМОЖНОСТЬ ВЫВЕСТИ ЦАВАЛОВА";
      
      Message_SpyDialog                      = "Наконец-то вы пришли, я знаю, как нам выбраться отсюда, но есть небольшая проблема, охранник в соседней комнате, с ним надо разобраться..";
      Message_SpyDialog_NoGuard              = "Наконец-то вы пришли, я знаю, как нам выбраться отсюда, а с охранником уже покончено? Тогда идите за мной.";
      Message_SpyDialog_DoorLocked           = "Наконец-то вы пришли, я знаю, как нам выбраться отсюда, но есть небольшая загвоздка, эта дверь заперта..";
      
      Message_SpyWaitThink                   = "! Вернитесь за Цаваловым..";
      Message_ICantGo                        = "@ Куда ты? С меня хватит приключений!";
      Message_YouAreIdiot                    = "@ Ты что? Кран не удержит нас!";
      Message_DangerFbi                      = "@ Ты куда? Нас же увидят?! Я туда не пойду!";
      
      Message_SpyAlert                       = "! Цавалова заметили! Если информация о побеге будет передана - миссия провалится!";
      Message_SpyBodyAlert                   = "! Обнаружено тело Цавалова. Если информация о побеге будет передана - миссия провалится!";
      Message_EmptyRoom                      = "! Обнаружено исчезновение Цавалова. Если информация о побеге будет передана - миссия провалится!";
      
      Message_Alarm                          = "Поднята тревога!";
      
      Key_Shop                               = "Ключ от магазина";
      Key_Backdoor                           = "Ключ от заднего выхода";
      Key_Garage                             = "Ключ от гаража";
      Key_Garderob                           = "Ключ от гардероба";
      Key_Spy                                = "Ключ от третьего этажа";
      
      Message_TaskChanged                    = "Задания изменены";
      
      Message_Help                           = { "При помощи канистры с бензином легко устроить пожар..",
                                                 "В магазинах могут храниться газовые балоны..",
                                                 "Тарелки и другие бьющиеся предметы можно использовать для оглушения противника",
                                                 "Некоторые предметы можно забрасывать в окно"
                                               };
  };
  
  MissionSamples = 
  {
  };
  

------------------------ Initialization and save/load ------------------------

--------------------------------------------------------
-- Name: Level.OnCompleteMission()
-- Desc:
--------------------------------------------------------
function Level.OnCompleteMission()

      System:ConsoleCommand( 'l_loadlevel "gamemenu" 1' ); -- forlik

end;

--------------------------------------------------------
-- Name: Level.OnFinishLoad()
-- Desc:
--------------------------------------------------------
  function Level.OnFinishLoad()
       Level.OnFinishLoad_Common();
       
       if (Level.LiftAnimating == true) then
          Level.EnableWorldObjectAnim( Level.FindWorldObject('RUCH'), true, 0.0, 143.0, 30.0, Level.LiftAnimFrame );
       end

       Level.EnableWorldObjectAnim( Level.FindWorldObject('PAT1'), true, 0.0, 15.0, 15.0 );
       Level.EnableWorldObjectAnim( Level.FindWorldObject('PAT2'), true, 0.0, 15.0, 15.0 );
       Level.EnableWorldObjectAnim( Level.FindWorldObject('PAT3'), true, 0.0, 15.0, 15.0 );

       System:SetVar( "r_shadowbrightness", 0.75 );
       System:SetVar( "r_rimsunlightfactor", 0.2 );
       Level.SetDOFPostFilter( 1, 0.0, 1500.0, 2500.0 );
       
       Level.SetHudEffect("noise_small" , true ); 

       Level.AddMusic( Level.MUSIC_MOOD_ACTION, "#0.75#sounds\\music\\sustain.ogg" );        
       Level.AddMusic( Level.MUSIC_MOOD_DEFAULT, "#0.4#sounds\\music\\b_dark5.ogg" );
       
       Level.SetDefaultMusicPause( 120.0, 210.0, 30.0, 120.0 );
       
       Level.SetDoorNotifyScript( Level.FindDoor('DR12'), true, true );
       Level.SetDoorNotifyScript( Level.FindDoor('DR08'), true );
       Level.SetDoorNotifyScript( Level.FindDoor('DR15'), true );
       Level.SetDoorNotifyScript( Level.FindDoor('DR01'), true );
       Level.SetDoorNotifyScript( Level.FindDoor('FD03'), true );
       
       -- music
       
       -- postfilter
       
       -- door key
       Level.SetDoorKey('DR02', 'KY02');
       Level.SetDoorKey('DR03', 'KY02');
       
       Level.SetDoorKey('VRDR', 'KYVR');
       
       Level.SetDoorKey('DR01', 'KY01');
       Level.SetDoorKey('DR17', 'KY01');
       
       Level.SetDoorKey('GZDR', 'KYGZ');
       
       Level.SetDoorKey('DR09', 'KYSP');
       Level.SetDoorKey('DR15', 'KYSP');
       
       if (Level.Door08Closed == true) then
          local door = Level.FindDoor( 'DR08' );

          if ( door != nil ) then
             AI.RegisterClosedDoor( door, true );
          end
       end
       
       if (Level.IsMissionTaskCompleted('FIRE') == true) then
          local doors = { 'DR08', 'DR15' };
          for i in doors do
             local door = Level.FindDoor(doors[i]);
             Level.SetDoorUnlockKey(door, "deadlock");
             AI.RegisterClosedDoor( door, true );             
          end
       end
       -- effects
       
       if (Level.PoliceLineCutted == false) then
          AI.RegisterClosedDoor( Level.FindDoor('DR12'), true );
       else
          Level.SetWorldObjectAnimFrame( Level.FindWorldObject('POLL'), 33.0 );       
       end;
       
       Level.NeedSetHudFadeIn    = false;
       Level.CanDisableExplosion = false;
       
       if ( Level.ExplosionDone == true ) then
          Level.PlayEffect( "Levels\\cowboy\\fire_window.sef" , 496.19287, 117.08772, -1240.70251, 0.0, -68.36087, 0.0 );       
          Level.AddMusic( Level.MUSIC_MOOD_ATTENTION, "#0.75#sounds\\music\\sustain.ogg" );       
       end;
  end;
 
--------------------------------------------------------
-- Name: Level.OnSave()
-- Desc:
--------------------------------------------------------
  function Level.OnSave()
       Stream.WriteInt(6);
       
       Level.WriteArray(Level.Boxes);
       Level.WriteArray(Level.BoxesDroped);
              
       Stream.WriteString(Level.ActiveDropBoxAnchor);
       
       Stream.WriteInt  (Level.LiftState);
       Stream.WriteBool (Level.LiftAnimating );
       Stream.WriteFloat(Level.LiftAnimFrame);
       
       Stream.WriteInt ( Level.LiftCutscenes );
       Stream.WriteBool( Level.PolicemanInvestigated );

       Stream.WriteString( Level.SearchZoneName );
       Stream.WriteBool  ( Level.SearchingStart );
       
       Stream.WriteBool ( Level.SearchJustFinished );
       
       Level.WriteArray(Level.FbiFollowDoor1);
       Level.WriteArray(Level.FbiFollowDoor2);
       
       Stream.WriteBool(Level.PlayerGasBalon);
       Stream.WriteBool(Level.PlayerKanistra);
       Stream.WriteBool(Level.PlayerSuitcase);
       
       Stream.WriteBool(Level.HadForbidObjects);
       Stream.WriteInt(Level.SearchTimes);
       
       Stream.WriteString( Level.EscortPlayerForm );

       Stream.WriteBool(Level.SpyAtRoom);
       Stream.WriteBool(Level.SpyDialog);
       
       Stream.WriteBool(Level.CanStartResqueAfterDialog);
       Stream.WriteBool(Level.SpyPlayerMove);
       Stream.WriteBool(Level.LiftSpyWait);
       
       Stream.WriteBool( Level.KabinetDroped );
       
       Stream.WriteBool( Level.AlertCalled );
       Stream.WriteBool( Level.FbiAlertCalled );
       
       Level.WriteArray( Level.SaySpyPhoneAnchors );
       
       Stream.WriteBool( Level.Door08Closed );
       Stream.WriteBool( Level.RoomInvestigating );
       
       Stream.WriteBool( Level.LineInvestigated );
       Stream.WriteBool( Level.SpyDoorLocked );
       
       Stream.WriteBool( Level.BarrelsDroped );
       Stream.WriteBool( Level.PoliceLineCutted );
       
       Stream.WriteBool( Level.FbiPolicemanJobChanged );
       
       Stream.WriteBool( Level.SpyTriggerWait );
       
       Stream.WriteBool( Level.PlayerGotSuitcase );
       
       Stream.WriteString( Level.HideDropEntity );
       
       Stream.WriteBool( Level.AtSearchZone );
       
       Stream.WriteInt( Level.BoardState );
       Stream.WriteInt( Level.BoardDeformation );
       
       Stream.WriteBool( Level.AtPutBodyTrigger );
       
       Stream.WriteBool( Level.KanistraAtRoom );
       Stream.WriteBool( Level.BalonAtRoom    );
       Stream.WriteBool( Level.DiplomatAtRoom );
       Stream.WriteBool( Level.OnlyFire );
       Stream.WriteBool( Level.ExplosionDone );
       
       -- version 2
       Stream.WriteBool( Level.HadSuitcase );
       
       -- version 3
       Stream.WriteBool( Level.PlayerAtTualet );
       Stream.WriteBool( Level.PlayerAtKitchen );
       Stream.WriteInt( Level.SpyMessageState );
       
       -- version 4
       Stream.WriteBool( Level.AgentHitted );
       
       -- version 5
       Stream.WriteBool( Level.AtPoliceZoneTrigger );
       
       -- version 6
       Stream.WriteInt( Level.GuardsKilledByExplosion );
       Stream.WriteInt( Level.CivilianKilledByExplosion );
       Stream.WriteInt( Level.GuardsHittedBeforeExplosion   );
       Stream.WriteInt( Level.CivilianHittedBeforeExplosion );
       
              
       Level.OnSave_Common();
  end

--------------------------------------------------------
-- Name: Level.OnLoad()
-- Desc:
--------------------------------------------------------
  function Level.OnLoad()
  
       local version                   = Stream.ReadInt();
       
       Level.Boxes                     = Level.ReadArray();
       Level.BoxesDroped               = Level.ReadArray();
       
       Level.ActiveDropBoxAnchor       = Stream.ReadString();
       
       Level.LiftState                 = Stream.ReadInt();
       Level.LiftAnimating             = Stream.ReadBool();
       Level.LiftAnimFrame             = Stream.ReadFloat();
       
       Level.LiftCutscenes             = Stream.ReadInt();
       Level.PolicemanInvestigated     = Stream.ReadBool();

       Level.SearchZoneName            = Stream.ReadString();
       Level.SearchingStart            = Stream.ReadBool();
       
       Level.SearchJustFinished        = Stream.ReadBool();
       
       Level.FbiFollowDoor1            = Level.ReadArray();
       Level.FbiFollowDoor2            = Level.ReadArray();

       Level.PlayerGasBalon            = Stream.ReadBool();
       Level.PlayerKanistra            = Stream.ReadBool();
       Level.PlayerSuitcase            = Stream.ReadBool();
       Level.HadForbidObjects          = Stream.ReadBool();
       Level.SearchTimes               = Stream.ReadInt();
       Level.EscortPlayerForm          = Stream.ReadString();
       Level.SpyAtRoom                 = Stream.ReadBool();
       Level.SpyDialog                 = Stream.ReadBool();
       
       Level.CanStartResqueAfterDialog = Stream.ReadBool();
       Level.SpyPlayerMove             = Stream.ReadBool();
       Level.LiftSpyWait               = Stream.ReadBool();
       
       Level.KabinetDroped             = Stream.ReadBool();
       Level.AlertCalled               = Stream.ReadBool();
       Level.FbiAlertCalled            = Stream.ReadBool();
       
       Level.SaySpyPhoneAnchors        = Level.ReadArray();
       
       Level.Door08Closed              = Stream.ReadBool();
       Level.RoomInvestigating         = Stream.ReadBool();
       Level.LineInvestigated          = Stream.ReadBool();
       Level.SpyDoorLocked             = Stream.ReadBool();
       Level.BarrelsDroped             = Stream.ReadBool();
       Level.PoliceLineCutted          = Stream.ReadBool();
       Level.FbiPolicemanJobChanged    = Stream.ReadBool();
       
       Level.SpyTriggerWait            = Stream.ReadBool();
       
       Level.PlayerGotSuitcase         = Stream.ReadBool();
       Level.HideDropEntity            = Stream.ReadString();
       
       Level.AtSearchZone              = Stream.ReadBool();
       
       Level.BoardState                = Stream.ReadInt();
       Level.BoardDeformation          = Stream.ReadInt();
       
       Level.AtPutBodyTrigger          = Stream.ReadBool();
       Level.KanistraAtRoom            = Stream.ReadBool();
       Level.BalonAtRoom               = Stream.ReadBool();
       Level.DiplomatAtRoom            = Stream.ReadBool();
       Level.OnlyFire                  = Stream.ReadBool();
       Level.ExplosionDone             = Stream.ReadBool();
       
       if (version >= 2) then
          Level.HadSuitcase               = Stream.ReadBool();
       end

       Level.PlayerAtTualet  = false;
       Level.PlayerAtKitchen = false;
       Level.AgentHitted     = false;
       Level.SpyMessageState = 0;
       Level.AtPoliceZoneTrigger = false;
       Level.GuardsKilledByExplosion       = 0;
       Level.CivilianKilledByExplosion     = 0;
       Level.GuardsHittedBeforeExplosion   = 0;
       Level.CivilianHittedBeforeExplosion = 0;
       
       if (version >= 3) then
          Level.PlayerAtTualet  = Stream.ReadBool( );
          Level.PlayerAtKitchen = Stream.ReadBool( );
          Level.SpyMessageState = Stream.ReadInt( );
       end
       
       if (version >= 4) then
          Level.AgentHitted               = Stream.ReadBool();
       end
       
       if (version >= 5) then
          Level.AtPoliceZoneTrigger       = Stream.ReadBool();
       end
       
       if (version >= 6) then
          Level.GuardsKilledByExplosion       = Stream.ReadInt();
          Level.CivilianKilledByExplosion     = Stream.ReadInt();
          Level.GuardsHittedBeforeExplosion   = Stream.ReadInt();
          Level.CivilianHittedBeforeExplosion = Stream.ReadInt();
       end
       
       Level.OnLoad_Common();     
       Level.OnFinishLoad();
  end
  
--------------------------------------------------------
-- Name: Level.OnLoaded()
-- Desc:
--------------------------------------------------------
  function Level.OnLoaded()

       Level.OnLoaded_Common();

       -- Initialize varibles..
       Level.SoundName  = { "Fire", "Fire01", "Fire02" };
       Level.SoundState = { false, false, false };
       
       Level.ActiveDropBoxAnchor = "";
       Level.BoxesDroped = { };
       
       Level.LiftState     = 0;
       Level.LiftAnimating = false;
       Level.LiftAnimFrame = 0.0;
       
       Level.LiftCutscenes = 0;
       Level.PolicemanInvestigated = false;
       
       Level.SearchZoneName  = "";
       Level.SearchingStart  = false;
       
       Level.SearchJustFinished = false;

       Level.FbiFollowDoor1 = { 'FB06', 'FB09' };
       Level.FbiFollowDoor2 = { 'FB08', 'FB02' };
       
       Level.PlayerGasBalon = false;
       Level.PlayerKanistra = false;
       Level.PlayerSuitcase = false;
       
       Level.HadForbidObjects = false;
       Level.HadSuitcase      = false;
       
       Level.EscortPlayerForm = "";
       
       Level.SearchTimes = 0;
       
       Level.SpyAtRoom = true;
       Level.SpyDialog = false;
       
       Level.CanStartResqueAfterDialog = true;
       
       Level.SpyPlayerMove          = false;
       Level.LiftSpyWait            = false;
       
       Level.KabinetDroped          = false;
       
       Level.AlertCalled            = false;
       Level.FbiAlertCalled         = false;
       
       Level.SaySpyPhoneAnchors     = { 'A257', 'A258', 'A259' };
       
       Level.Door08Closed           = true;
       Level.RoomInvestigating      = false;
       
       Level.LineInvestigated       = false;
       Level.SpyDoorLocked          = true;
       
       Level.BarrelsDroped          = false;
       Level.PoliceLineCutted       = false;
       
       Level.FbiPolicemanJobChanged = false;
       
       Level.HideDropEntity         = "";
              
       Level.SpyTriggerWait         = false;
       Level.PlayerGotSuitcase      = false;
       Level.AtSearchZone           = false;
       
       Level.BoardState             = 1;
       Level.BoardDeformation       = 0;
       
       Level.AtPutBodyTrigger       = false;
       Level.KanistraAtRoom         = false;
       Level.BalonAtRoom            = false;
       Level.DiplomatAtRoom         = false;
       
       Level.OnlyFire               = false;
       Level.ExplosionDone          = false;
       
       Level.PlayerAtTualet         = false;
       Level.PlayerAtKitchen        = false;
       
       Level.SpyMessageState        = 0;
       Level.AgentHitted            = false;
       Level.AtPoliceZoneTrigger    = false;
       
       Level.GuardsKilledByExplosion   = 0;
       Level.CivilianKilledByExplosion = 0;
       
       Level.GuardsHittedBeforeExplosion   = 0;
       Level.CivilianHittedBeforeExplosion = 0;
       
       -- Action handlers..
       Level.AddActionHandler( Level.AH_ACTOR_BODY_INFO,    'PL01', "OnPolicemanBodyInfo" );
       Level.AddActionHandler( Level.AH_ACTOR_KILLED ,      'FSPY', "OnKillSpy");
       Level.AddActionHandler( Level.AH_ACTOR_HITTED ,      'FSPY', "OnHitSpy");
       Level.AddActionHandler( Level.AH_FOLLOW_WAIT_THINK , 'FSPY' , "OnFollowWaitThink");

       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WRFB', "OnChangeFbiCloth" );
       
       
       -- Items..
       Level.Boxes = { 'WB22', 'WB24', 'WB21', 'WB23', 
                       'WB07', 'WB08', 'WB06', 'WB25',
                       'WB09', 'WB02', 'WB26', 'WB05',
                       'WB04', 'WB27', 'WB11', 'WB15',
                       'WB12', 'WB14' };
       for i in Level.Boxes do
          local box = Level.FindItem(Level.Boxes[i]);
          if (box != nil) then
             Level.EnableItemPickup( box, false );
             Level.EnableEquipmentNotify( box, "drop", true );
          else
             print("Can't find box: " .. Level.Boxes[i]);
          end
       end
       
       local bidon = Level.FindItem('BD01');
       if (bidon != nil) then
          Level.EnableEquipmentNotify( bidon, "pickup", true );
       else
          print("Warning: Can't find bidon BD01");
       end
       
       local suitcase = Level.FindItem('SC01');
       if (suitcase != nil) then
          Level.EnableEquipmentNotify( suitcase, "pickup", true );
          Level.EnableEquipmentNotify( suitcase, "drop", true );
          
          Entity.SetName( suitcase, MissionText.Message_SuitcaseWithExplosion );
       else
          print("Warning: Can't find suitcase: SC01");
       end
       
       local kanistra = Level.FindItem('KN01');
       if (kanistra != nil) then
          Level.EnableEquipmentNotify( kanistra, "pickup", true );
          Level.EnableEquipmentNotify( kanistra, "drop", true );
          Level.EnableNotifyHitBullet( kanistra, true );
	   else
          print("Warning: Can't find kanistra: KN01");
       end

       local gasbalon = Level.FindItem('GB01');
       if (gasbalon != nil) then
          Level.EnableEquipmentNotify( gasbalon, "pickup", true );
          Level.EnableEquipmentNotify( gasbalon, "drop", true );
          Level.EnableNotifyHitBullet( gasbalon, true );
	   else
          print("Warning: Can't find gasbalon: GB01");
       end
       
       Level.ForEachEntity("", "PreparePlate", 602.0657, 24.6189, -1085.7589, 608.0051, 35.6189, -1075.3240);
       
       -- Init player..
       local player     = Level.FindActor('PLYR');
       if ( player != nil ) then

          if ( Level.HasPlayerEquipPack() == false ) then

             local pistol     = Level.CreateItem("HiStandart","Weapon");
             local knife      = Level.CreateItem("KnifeNR43","Weapon");
 
             Actor.PutWeapon( player, Actor.WEAPON_SLOT_PISTOL, pistol );
             Actor.PutWeapon( player, Actor.WEAPON_SLOT_KNIFE, knife );

             Actor.PutWeaponAmmo( player, "HiStandart");

             Actor.PutEmptyPouch( player, "fiberwire", "Weapon" );
             Actor.PutEmptyPouch( player, "lockpick", "Equipment" );
             Actor.PutEmptyPouch( player, "chloroform", "Weapon" );
          end;
          
          Actor.ChangeActorSkin( player, "Jacket" );
          Actor.SetActorTypeId(player, Actor.ACTOR_TYPE_CIVILIAN, Actor.ACTOR_NATION_BRITISH );
       end;
       
       -- marks:
       -- hmm...
       Level.EnableLevelMark('SUIT', true);
       Level.EnableLevelMark('KANS', true);
       
       if (Level.GetDifficulty() == 0) then
          Level.EnableLevelMark('LIFT', true);
       end
       
       -- Keys:
       
       Level.SetDoorLockedId('DR09', false);

       Level.AddKey('T210', 'KY02', MissionText.Key_Shop, nil, true );
       Level.AddKey('FB10', 'KY01', MissionText.Key_Backdoor, nil, true);
       Level.AddKey('FB02', 'KYVR', MissionText.Key_Garage, nil, true );
       Level.AddKey('FB18', 'KYGZ', MissionText.Key_Garderob, nil, true);
       Level.AddKey('FB30', 'KYSP', MissionText.Key_Spy, nil, true );

       -- ai:
       AI.OnPlayerEnterZone("global", 'GLSC');

       AI.ChangeLogic(AI.FindNPC('FSPY'), "CivilianScriptFriend");
       
       AI.EnableZone( "SearchAlertZone", false );
       AI.EnableZone( "GasKanistraZone", false );
       AI.EnableZone( "NoWeapon", false );
       AI.EnableZone( "House3LineAlarm",    false );
       AI.EnableZone( "PolicemanWeaponZone", false );
       AI.EnableZone( "House3_EastAlarm", false );
       
       AI.ChangeLogic( AI.FindNPC('FB05'), "LiteScriptSoldier" );
       AI.ChangeLogic( AI.FindNPC('FB07'), "LiteScriptSoldier" );
       
       AI.RebuildPlayerForm();
       AI.SetPlayerForm("Civilian");
       AI.SetPlayerDefaultForm("Civilian");
       
       AI.AddBlockVisionBox(480.4352,67.7224,-1177.1343,483.4352,89.7224,-1165.1343);
       AI.AddBlockVisionBox(480.4352,67.7224,-1087.0613,483.4352,89.7224,-1075.0613);
       AI.AddBlockVisionBox(441.1703,67.7224,-1313.8497,444.1703,89.7224,-1301.8497);
       
       -- AI.AddBlockVisionBox(480.3514,115.3904,-1139.2314,483.3514,137.3904,-1127.2314);
       
       -- car bbox:
       AI.AddBlockVisionBox(-329.6084, -10.0200, -1463.9020, -303.6877, 28.0866, -1412.9220);
       
       -- constr house box:
       AI.AddBlockVisionBox(267.0638, 18.4273, -1260.9939, 274.0306, 43.4272, -1257.1453);
       AI.AddBlockVisionBox(220.9060, 18.7103, -1260.7087, 227.8729, 43.7103, -1256.8601);
       
       AI.AddBlockVisionBox(220.9060, 64.9538, -1260.7087, 227.8729, 89.9537, -1256.8601);
       AI.AddBlockVisionBox(237.9953, 65.9956, -1263.2560, 257.2570, 90.9955, -1263.0179);
       AI.AddBlockVisionBox(152.7404, 66.3060, -1254.1553, 163.6297, 84.1490, -1253.9172);
       
       AI.AddHideBodyBox(168.3224,7.2022,-1077.1932,175.3224,20.2022,-1070.1932);                         
       
       AI.Enable("notify_see_custom_actor");
       AI.Enable("notify_visited_body");
       
       AI.AddScriptDynamicObstacle( 'BORD', 405.6889, 105.6769,-1196.0234,460.6889,125.6769,-1186.0234 );
       AI.AddScriptDynamicObstacle( 'DR08', 565.0493, 107.7541, -1251.6084, 567.2475, 132.7541, -1236.6084);
       AI.AddScriptDynamicObstacle( 'POLN', 999.3486, 11.7581, -1904.0782, 1001.4080, 36.7581, -1889.0782);
       AI.AddScriptDynamicObstacle( 'DR01', 683.0703, 10.7578, -1234.2472, 698.0703, 36.7578,-1232.0490);
       AI.AddScriptDynamicObstacle( 'FD03', 950.2341, 11.7478, -2034.3833, 965.2341, 36.7478, -2032.0236 );
       
       AI.SetTaskLimit( AI.TASK_FOLLOW_PLAYER, 5 );
       AI.SetTaskLimit( AI.TASK_INVESTIGATE_BODY, 5 );
       AI.SetTaskLimit( AI.TASK_INVESTIGATE_COMBAT, 10 );       
       
       AI.AddCustomObject('SPRM', 533.0, 125.46, -1224.13, false);
       
       AI.Disable(AI.FindNPC('FSPY'), "can_see_custom_object");
       
       NPC.SetFlag( AI.FindNPC('FB30'), NPC.F_CANT_OPEN_LOCK_DOOR, true );
       NPC.SetFlag( AI.FindNPC('FB29'), NPC.F_CANT_OPEN_LOCK_DOOR, true );
       NPC.SetFlag( AI.FindNPC('FB26'), NPC.F_CANT_OPEN_LOCK_DOOR, true );
       NPC.SetFlag( AI.FindNPC('FB27'), NPC.F_CANT_OPEN_LOCK_DOOR, true );
       
       NPC.SetFlag( AI.FindNPC('ML01'), NPC.F_CANT_OPEN_LOCK_DOOR, false );
       
       local worker = AI.FindNPC('CW16');
       if (worker != nil) then
          AI.SetConfLogic( worker, "scripts:ConfLogic\male_usa_guards_conf.shadvs" );
          AI.SetJob(worker, "default");
       else
          print("Can't find worker: CW16");
       end
       
       -- timers
       Level.AddTimer( 'CFJB', "OnDoFbiPatrol", 200.0, true );
       Level.AddTimer( 'FBGO', "OnFbiGoFirstFloor", 150.0, true );
       
       Level.InstallDpc("Level.StartCivilianIdleJob()", 1.0);       
       
       -- Init mission tasks..
       Level.InstallInitialTasks();
       
       local body = AI.FindNPC('BODY');
       AI.KillNPC(body, 0.0);
       
       Level.InstallDpc("Level.DoRagdollStuff()", 0.001 );
       --Level.DoRagdollStuff();
       
                            
       Level.UpdateLift(1);       
       Level.UpdatePoliceLineState( 0 );
       Level.UpdateBoard(0);
       
       Level.HideWorldObject( 'RAMA' );
       
       Level.HideWorldObject( 'PRT1' );
       Level.HideWorldObject( 'PRT2' );
       Level.HideWorldObject( 'PRT3' );

       Level.HideWorldObject( 'PRT4' );
       Level.HideWorldObject( 'PRT5' );
       Level.HideWorldObject( 'PRT6' );
       Level.HideWorldObject( 'PRT7' );
       
       Level.HideWorldObject( 'BRS1' );
       Level.HideWorldObject( 'BRS2' );
       Level.HideWorldObject( 'BRP1' );
       Level.HideWorldObject( 'BRP2' );
       
       Level.HideWorldObject( 'BRDA' );
                    
       -- Finish load..
       Level.OnFinishLoad();
       Level.OnLoadedDifficulty();
  end;
      
  --------------------------------------------------------
  -- Name: Level.DoRagdollStuff()
  -- Desc:
  --------------------------------------------------------
  function Level.DoRagdollStuff()
  
     Actor.SerializeRagdoll( Level.FindActor('BODY'), "Levels\\Cowboy\\deadbody.ragdoll" , true );
       
  end;
  --------------------------------------------------------
  -- Name: Level.OnLoadedDifficulty()
  -- Desc:
  --------------------------------------------------------
  function Level.OnLoadedDifficulty()
     local diff = Level.GetDifficulty();
     
     if (diff < 2) then
        AI.EnableZone("ChWorkerFbiZone", false);
     end
    
     if (diff != 2) then
        if (diff == 0) then
           Level.AddTimer( 'MDMJ', "OnDoMadamJob", 120.0, true );
        elseif (diff == 1) then
           Level.AddTimer( 'MDMJ', "OnDoMadamJob", 325.0, true );
        else
           Level.AddTimer( 'MDMJ', "OnDoMadamJob", 250.0, true );
        end
     end
     
     if (diff >= 2) then
        AI.EnableZone( "BehindMainHouse", false );
        
        Level.EnableLevelMark('KANS', false);
     end
     
     if (diff == 0) then
        Level.EnableLevelMark('ETAS', true);
     end
     
     if (Level.GetDifficulty() < 2) then
        --Level.LockDoor('DR14', false);
        Level.LockDoor('DR06', false);
     end
     
     
     -- update anchors...
     if (diff >= 2) then
        local anchors = { 'AN80', 'A142', 'A148', 'A149',
                          'A280', 'A281', 'A282', 'A283', 'A284', 
                          'A285', 'A286', 'A287', 'A288', 'A289' };
                          
        for i in anchors do
           local anchor = AI.FindAnchor(anchors[i]);
           if (anchor != nil) then
              AI.EnableRandomIdleAnchor( anchor, false );
           else
              print("Warning: Can't find anchor: " .. anchors[i]);
           end
        end
     else
        local anchors = { 'A281', 'A282', 'A283', 'A284', 'A285', 
                          'A286', 'A287', 'A288', 'A289' };

        for i in anchors do
           local anchor = AI.FindAnchor(anchors[i]);
           if (anchor != nil) then
              AI.EnableRandomIdleAnchor( anchor, false );
           else
              print("Warning: Can't find anchor: " .. anchors[i]);
           end
        end
     end
     
     if (Level.GetDifficulty() == 3) then
        local form_eq = { 'WRFB', 'WCW1' };
        for i in form_eq do
           Level.HideItem( form_eq[i] );
        end
        
        local anchor = AI.FindAnchor('A282');
        if (anchor != nil) then
           AI.EnableRandomIdleAnchor( anchor, false );
        end
     end
  end
    
  AI.DoFile( "scripts:Levels\\Common.lua", false );

------------------------------- Level logic ----------------------------------

--------------------------------------------------------
-- Name: Level.InstallInitialTasks()
-- Desc:
--------------------------------------------------------
  function Level.InstallInitialTasks()
     Level.StartTask(MissionText.Task_Rescue,  'RESC', "Levels\\Cowboy\\rescue_task.txt", true, 0 );
     Level.StartTask(MissionText.Task_Body,    'BODY', "Levels\\Cowboy\\body_task.txt",   true, 0 );
     -- Level.StartTask(MissionText.Task_Fire,    'FIRE', "Levels\\Cowboy\\fire_task.txt",   true, 0 );
  end

--------------------------------------------------------
-- Name: Level.RunLogic()
-- Desc:
--------------------------------------------------------
  function Level.RunLogic(completed)
     if (Level.CheckMissionTaskCompleted('BODY', completed) == true and
         Level.CheckMissionTaskCompleted('RESC', completed) == true and
         Level.HasMissionTask('FIRE') == false) then
         
        Level.StartTask(MissionText.Task_Fire,    'FIRE', "Levels\\Cowboy\\fire_task.txt",   true, 0 );
        Level.StartTask(MissionText.Task_Leave,   'LEAV', "Levels\\Cowboy\\leave_task.txt",   true, 0 );
        
        return true; 
     end
  
     return false;
  end

--------------------------------------------------------
-- Name: Level.IsMissionTaskOver()
-- Desc:
--------------------------------------------------------
  function Level.IsMissionTaskOver(taskId)
     return Level.IsMissionTaskCompleted(taskId);
  end

--------------------------------------------------------
-- Name: Level.StartTask()
-- Desc:
--------------------------------------------------------
  function Level.StartTask(text, taskId, taskDscr, isImportant, floor )
     if (Level.HasMissionTask(taskId) != false) then
        return; 
     end

     if (taskId == 'RESC') then
        local actor = Level.FindActor('FSPY');
        if (actor != nil) then
           Actor.MarkAsTarget( actor, true );
           Actor.SetMarkAsFriend( actor, true );
        else
           print("Error: Can't find spy");
        end
        
        AI.EnableZone("PlayerSpyZone", true);
        
     elseif (taskId == 'BODY') then
     elseif (taskId == 'FIRE') then
     
        Level.EnableLevelMark('FIRE', true);                        
        Level.EnableLevelMark('SUIT', false);
        
        if (Level.PlayerGotSuitcase == false) then
           Level.EnableLevelMark('SUIF', true);
        end
        
     elseif (taskId == 'LEAV') then
     
        Level.EnableLevelMark('LEAV', true);
        
     end

     Level.AddMissionTask( text, taskId, taskDscr, floor, isImportant );
  end

--------------------------------------------------------
-- Name: Level.FinishTask()
-- Desc:
--------------------------------------------------------
  function Level.FinishTask(taskId, completed)
     if (Level.HasMissionTask(taskId) == false or
         Level.IsMissionTaskCompleted(taskId) != false) then
        return; 
     end

     if (taskId == 'RESC') then
     
        local spy = AI.FindNPC('FSPY');
        if (spy != nil) then
           AI.FailTask(spy, AI.TASK_FOLLOW_ACTOR);
           AI.SetJob(spy, "waitplayer2");
           
           AI.HandleVoice(spy, "%Script04_Sound");
        end
        
        Level.RemovePlayerActorAction('MOVE');
        if (Level.HasPlayerAction('MOVE') == true) then
           Level.RemovePlayerAction('MOVE');
        end
        
        AI.SetWatchActor( nil );
        AI.EnableZone("PlayerSpyZone", false);

        local actor = Level.FindActor('FSPY');
        if (actor != nil) then
           Actor.EnablePickBody( actor, false );
           Actor.MarkAsTarget( actor, false );
        end
        
        Level.EnableLevelMark('RESC', false);
        
        -- if (Level.GetDifficulty() == 1) then
        AI.EnableZone("ChWorkerFbiZone", false);
        -- end
       
     elseif (taskId == 'FIRE') then
        Level.EnableLevelMark('FIRE', false);
        Level.EnableLevelMark('SUIT', false);
        Level.EnableLevelMark('SUIF', false);
        Level.EnableLevelMark('KANS', false);
        
        AI.EnableZone("Floor3NearSpyRoom", false);
        Level.InstallDpc("AI.EnableZone('Floor3NearSpyRoom', true)", 25.0);
        
        AI.OnPlayerEnterZone("FireZone", 'FRZN');

     elseif (taskId == 'BODY') then
     
        Level.EnableLevelMark('BODY', false);

        local actor = Level.FindActor('BODY');
        if (actor != nil) then
           Actor.EnablePickBody( actor, false );
        end
        
     elseif (taskId == 'LEAV') then
     
        Level.EnableLevelMark('LEAV', false);
        
     end

     if (completed != false) then
        if (Level.RunLogic(taskId) == true) then
           Level.CompleteMissionTask(taskId);
           Level.AddLargeMessage( MissionText.Message_TaskChanged, 10.0, 255, 255, 255 );
        else
           Level.CompleteMissionTask(taskId);
        end

        Level.PlayMenuSound("task_finish");
     else
        Level.RemoveMissionTask(taskId);

        if (Level.RunLogic(nil) == true) then
           Level.AddLargeMessage( MissionText.Message_TaskChanged, 10.0, 255, 255, 255 );
           Level.PlayMenuSound("task_finish");
        end
     end     
  end

--------------------------------------------------------
-- Name: Level.FailEscort()
-- Desc:
--------------------------------------------------------
  function Level.FailEscort()
     AI.FailTask(Level.GetCurrentEscortMan(), AI.TASK_FOLLOW_ACTOR );
     Level.RemoveDpc("Level.FailEscortScriptTask()");
  end

--------------------------------------------------------
-- Name: Level.OnEnterTriggerArea()
-- Desc:
--------------------------------------------------------
  function Level.OnEnterTriggerArea( sender, trgname, trgcmd )
     -- print("Level.OnEnterTriggerArea " .. trgname);
     
     if (trgname == "AddEscortTrigger_01") then
        
        Level.OnEnterEscortTrigger(1);
     
     elseif (trgname == "PoliceZoneTrigger") then
     
        Level.AtPoliceZoneTrigger = true;
        
     elseif (trgname == "AddEscortTrigger_02") then
        Level.OnEnterEscortTrigger(2);
     elseif (trgname == "GuardRoomTrigger") then
        
        local escortMan = Level.GetCurrentEscortMan();
        if (escortMan != nil and AI.GetPlayerForm() == "Milkman") then
           Level.RunAnchorJob(escortMan, 'A236', true);
        end
        
        Level.PlayerAtKitchen = true;
        
     elseif (trgname == "TualetTrigger") then
        
        local escortMan = Level.GetCurrentEscortMan();
        if (escortMan != nil and AI.GetPlayerForm() == "Policeman") then
           Level.RunAnchorJob(escortMan, 'A237', true);
           
           if (Level.GetDifficulty() < 2) then
              Level.InstallSingleDpc("Level.FailEscort()", 30.0);
           else
              Level.InstallSingleDpc("Level.FailEscort()", 60.0);
           end
        end
        
        Level.PlayerAtTualet = true;
        
     elseif (trgname == "PutBodyTrigger") then
        if (Level.IsMissionTaskCompleted('BODY') == false) then
           Level.AddTimer('PBTM', "OnCheckPutBody", 1.0, true);
        end
        
        Level.AtPutBodyTrigger = true;        
     elseif (trgname == "NearExitTrigger") then
        if (Level.IsMissionTaskCompleted('RESC') == false) then
           Level.AddTimer('EXCS', "OnExitCheckSpy", 1.0, true);
        end
        
        if (Level.IsMissionTaskCompleted('RESC') == true and
            Level.IsMissionTaskCompleted('BODY') == true and
            Level.IsMissionTaskCompleted('FIRE') == true and
            Level.IsMissionTaskCompleted('LEAV') == false) then
            
            Level.FinishTask('LEAV');
        end

     elseif (trgname == "CheckObjectsTrigger") then
        
        if (Level.IsMissionTaskCompleted('RESC') == true and
            Level.IsMissionTaskCompleted('BODY') == true and
            Level.IsMissionTaskCompleted('FIRE') == false and
            Level.HasMissionTask('FIRE') == true) then
           
           Level.RemoveDpc("Level.StartFireCutScene()");
           
           if ( Level.CanStartFireCutScene() == true ) then
             Level.StartFireCutScene();           
           else
             Level.InstallSmartDpc("Level.StartFireCutScene()", 1.0, "Level.CanStartFireCutScene()");
           end;
        end
        
     elseif (trgname == "SoundFaderTrigger") then
        AI.AddSoundFader('SPRF', "", 540.24, 127, -1239, 70.0, 150.0);     
     elseif (trgname == "ResqueSpyTrigger") then
        if (Level.IsMissionTaskCompleted('RESC') == false and
            Level.SpyAtRoom == true) then
            
            Level.RemoveDpc("Level.StartSpyDialog()");
            Level.RemoveDpc("Level.StartSpyResqueScript()");
            Level.InstallSmartDpc("Level.StartSpyDialog()", 1.0, "Level.CanStartSpyDialog()");
            Level.InstallSmartDpc("Level.StartSpyResqueScript()", 1.0, "Level.CanStartSpyResqueScript()");
        end
     elseif (trgname == "YouAreIdiotTrigger") then
        if (Level.SpyPlayerMove == true and Level.IsMissionTaskCompleted('RESC') == false) then
           Level.VoiceMessage(AI.FindNPC('FSPY'), "%Script05_Sound", "Message_YouAreIdiot");
           Level.SpyFollowPlayer( true );
           Level.LiftSpyWait = true;
        end
     elseif (trgname == "BoardDeformationTrigger") then
        
        Level.NextBoardDeformation();
        
     elseif (trgname == "PolicemanWeaponZoneTrigger") then
     
        Level.AddTimer( 'CEPZ', "CheckEnablePolicemanZone", 2.0, true );
        AI.OnPlayerEnterZone("PolicemanWeaponZone", 'PLWZ');
        
     elseif (trgname == "HackSearchZoneTrigger_01" or
             trgname == "HackSearchZoneTrigger_02") then
        
        Level.AtSearchZone = true;
        
        if ((AI.IsDefault(AI.FindNPC('FB05')) == true and trgname == "HackSearchZoneTrigger_02") or
            (AI.IsDefault(AI.FindNPC('FB07')) == true and trgname == "HackSearchZoneTrigger_01")) then
            
           if (AI.IsZoneEnabled("SearchZone_1") == true or
               AI.IsZoneEnabled("SearchZone_2") == true) then
           
              AI.EnableZone("SearchAlertZone", true);
              local disableZoneString = "AI.EnableZone('SearchAlertZone', false)";
              Level.RemoveDpc(disableZoneString);
              Level.InstallDpc(disableZoneString, 20.0);
           end            
        end
     elseif ( trgname == "FireKillTrigger" ) then
     
        if ( Level.ExplosionDone == true ) then
           Level.KillPlayer();        
        end;
     
     end;
  end

--------------------------------------------------------
-- Name: Level.CanFailScriptTask_Milkman()
-- Desc:
--------------------------------------------------------
  function Level.CanFailScriptTask_Milkman()
     local escortMan = Level.GetCurrentEscortMan();
     
     if (escortMan == nil) then
        return true;
     end
     
     if (AI.HasPlayerInfo(escortMan, "see") == false) then
        return false;
     end
     
     if (Level.PlayerAtKitchen == true) then
        return false;
     end
     
     if (AI.GetPlayerForm() != "Milkman") then
        return false;
     end
     
     return true;
  end
  
--------------------------------------------------------
-- Name: Level.CanFailScriptTask_Policeman()
-- Desc:
--------------------------------------------------------
  function Level.CanFailScriptTask_Policeman()
     local escortMan = Level.GetCurrentEscortMan();
     
     if (escortMan == nil) then
        return true;
     end
     
     if (AI.HasPlayerInfo(escortMan, "see") == false) then
        return false;
     end
     
     if (Level.PlayerAtTualet == true) then
        return false;
     end
     
     if (AI.GetPlayerForm() != "Policeman") then
        return false;
     end
     
     return true;
  end

--------------------------------------------------------
-- Name: Level.FailEscortTask()
-- Desc:
--------------------------------------------------------
  function Level.FailEscortScriptTask()
     local escortMan = Level.GetCurrentEscortMan();
     if (escortMan != nil) then
        AI.FailTask(escortMan, AI.TASK_SCRIPT_DEFAULT);
     end
  end
  
--------------------------------------------------------
-- Name: Level.OnLeaveTriggerArea()
-- Desc:
--------------------------------------------------------
  function Level.OnLeaveTriggerArea( sender, trgname, trgcmd )
     if (trgname == "GuardRoomTrigger") then
        
        -- local escortMan = Level.GetCurrentEscortMan();
        -- if (escortMan != nil and AI.GetPlayerForm() == "Milkman") then
        --   AI.FailTask(escortMan, AI.TASK_SCRIPT_DEFAULT);
        -- end
        
        Level.PlayerAtKitchen = false;
        
        if (Level.CanFailScriptTask_Milkman() == true) then
           Level.FailEscortScriptTask();
        else
           Level.InstallSingleSmartDpc("Level.FailEscortScriptTask()", 1.0, "Level.CanFailScriptTask_Milkman()");
        end
        
     elseif (trgname == "PoliceZoneTrigger") then
     
        Level.AtPoliceZoneTrigger = false;
        
     elseif (trgname == "TualetTrigger") then
        
        -- local escortMan = Level.GetCurrentEscortMan();
        -- if (escortMan != nil and AI.GetPlayerForm() == "Policeman" ) then
        --    AI.FailTask(escortMan, AI.TASK_SCRIPT_DEFAULT);
        -- end
        
        Level.PlayerAtTualet = false;
        
        if (Level.CanFailScriptTask_Policeman() == true) then
           Level.FailEscortScriptTask();
        else
           Level.InstallSingleSmartDpc("Level.FailEscortScriptTask()", 1.0, "Level.CanFailScriptTask_Policeman()");
        end        
        
        Level.RemoveDpc("Level.FailEscort()");
        
     elseif (trgname == "CheckObjectsTrigger") then
     
        Level.RemoveDpc("Level.StartFireCutScene()");
        
     elseif (trgname == "PutBodyTrigger") then
     
        Level.RemoveTimer('PBTM');
        Level.AtPutBodyTrigger = false;
        
     elseif (trgname == "NearExitTrigger") then
     
        Level.RemoveTimer('EXCS');
        
     elseif (trgname == "SoundFaderTrigger") then
     
        AI.RemoveSoundFader('SPRF');
        
     elseif (trgname == "ResqueSpyTrigger") then
     
        Level.RemoveDpc("Level.StartSpyDialog()");
        Level.RemoveDpc("Level.StartSpyResqueScript()");
        
     elseif (trgname == "YouAreIdiotTrigger") then
     
        if (Level.LiftSpyWait == true and Level.IsMissionTaskCompleted('RESC') == false) then
           Level.SpyFollowPlayer( false );
           Level.LiftSpyWait = false;
        end
        
     elseif (trgname == "HackSearchZoneTrigger_01" or
             trgname == "HackSearchZoneTrigger_02") then
        
        Level.AtSearchZone = false;
        
     elseif (trgname == "PolicemanWeaponZoneTrigger") then
     
        Level.RemoveTimer( 'CEPZ' );
        AI.OnPlayerLeaveZone("PolicemanWeaponZone", 'PLWZ');
     end
  end

--------------------------------------------------------
-- Name: Level.OnExecutePlayerAction()
-- Desc:
--------------------------------------------------------
  function Level.OnExecutePlayerAction(id, completeUnregisterTrigger ) 
  
     if (Level.CanAddPlayerAction(id) == nil) then
        return false;
     end

     local onFinishUnregister = false;
       
     if ( id == "Trigger_DropBarrels") then
        if ( Level.StartPlayerCustomAnim("Stand_Punch", 0, true, true, 'DRBR') == false ) then
           return false;
        end;
        
        AI.StartDecamouflage( 50.0, 100.0, 1.5 );
        
     elseif (id == "Trigger_DropKitchenCabinet") then

        if ( Level.StartPlayerCustomAnim("Custom_ShelfOverturn", 0, true, true, 'DFTC', false) == false ) then
           return false;
        end;
        
     elseif (id == "Trigger_UseLift") then

        if ( Level.StartPlayerCustomAnim("Custom_Traktor", 0, true, true, 'TRKT', false ) == false ) then
           return false;
        end;
        
        AI.StartDecamouflage( 50.0, 100.0, 4.0 );
        
        Level.FinishAnimTrigger    = "";
        Level.FinishAnimUnregister = false;
        
        return false;
        
     end;
     
     if ( onFinishUnregister == false ) then
     
        Level.FinishAnimTrigger    = id;
        Level.FinishAnimUnregister = completeUnregisterTrigger;
     
     else
     
        Level.FinishAnimTrigger    = "";
        
        if ( completeUnregisterTrigger == true ) then
        
            local t = Level.FindTrigger( id );
            if ( t != nil ) then            
                Level.UnregisterTrigger( t );            
            end;
        end;
     end;
     
     return true;
  end

--------------------------------------------------------
-- Name: Level.CanAddPlayerAction()
-- Desc:
--------------------------------------------------------
  function Level.CanAddPlayerAction(id)
     if ( Level.FinishAnimTrigger != "" ) then
        return nil;     
     end;
     
     if ( id == "Trigger_DropBarrels" ) then
        return MissionText.Action_DropBarrels;
     elseif (id == "Trigger_DropKitchenCabinet") then
        return MissionText.Action_DropKitchenCabinet;
     elseif (id == "Trigger_UseLift") then
        return MissionText.Action_UseLift;
     end
         
     return nil;
  end

  --------------------------------------------------------
  -- Name: Level.OnAlert()
  -- Desc:
  --------------------------------------------------------
  function Level.OnAlert( alertGroupId )
     AI.Debug(npc, "Level.OnAlert", tostring(alertGroupId));
     
     AI.SetLocalAlert(alertGroupId, true);
     
     if (alertGroupId == 0 or alertGroupId == 4 or alertGroupId == 5) then
         AI.SetLocalAlert(0, true);
         AI.SetLocalAlert(4, true);
         AI.SetLocalAlert(5, true);
         
        if (Level.AlertCalled == false) then     
           AI.SetJob("alive", "alert");     
        
           Level.AlertCalled = true;
           
           AI.OnPlayerEnterZone("AlertZone", 'ALZN');
        end         
     end
     
     if (alertGroupId == 1 or alertGroupId == 2 or alertGroupId == 3) then
         AI.SetLocalAlert(1, true);
         AI.SetLocalAlert(2, true);
         AI.SetLocalAlert(3, true);
         
        if (Level.FbiAlertCalled == false) then     
           AI.SetJob("alive", "fbialert");     
        
           Level.FbiAlertCalled = true;
           
           AI.OnPlayerEnterZone("FbiAlertZone", 'FAZN');
        end
     end

     Level.AlarmMessage( MissionText.Message_Alarm );
     AI.AddAlertValue(2);
  end

  --------------------------------------------------------
  -- Name: Level.OnFinishAlert()
  -- Desc:
  --------------------------------------------------------
  function Level.OnFinishAlert( alertGroupId )
     AI.Debug(nil, "Level.OnFinishAlert", tostring(alertGroupId));
  end
  
  --------------------------------------------------------
  -- Name: Level.OnStopMove()
  -- Desc:
  --------------------------------------------------------
  function Level.OnStopMove( actorId , npc )

     if (npc == nil) then
        print("Bad npc " .. tostring(actorId));
        return;
     end

     local npcForm    = AI.GetForm( npc );
     local zone       = AI.GetPrimaryPlayerZone( npc );
     local playerForm = AI.GetPlayerForm();
     local npcClass   = AI.GetClass( npc );
     
     if (zone == nil) then 
        return;
     end
     
     if (zone == "SearchZone_1" or zone == "SearchZone_2") then
     
        local playerPosition = Level.GetPlayerPosition();
        local npcPosition = Level.GetNpcPosition(npc);
        
        AI.EnableZone("SearchAlertZone", true);
        local disableZoneString = "AI.EnableZone('SearchAlertZone', false)";
        Level.RemoveDpc(disableZoneString);
        Level.InstallDpc(disableZoneString, 20.0);
        
        Level.SearchZoneName = zone;
        
        if (playerForm != "Civilian" and playerForm != "Worker") then
           if (Level.GetSearchMan() == nil) then
           
              local cameraName   = "Levels\\Cowboy\\" .. Level.SearchZoneName .. ".scm";
           
              local dofParams;
           
              if ( zone == "SearchZone_1" ) then
                 dofParams = { 1, 0.0, 200.0, 250.0, 255 };
              else
                 dofParams = { 1, 0.0, 120.0, 180.0, 255 };
              end;
           
              Level.BeginCutScene(nil, cameraName, MissionText.Message_StopMove_Search, 3.0, dofParams );
              
              if (Level.PlayerSuitcase == false) then
                 AI.HandleVoice( npc, "male_usa_script_script_37");
              else
                 AI.HandleVoice( npc, "male_usa_script_script_43");
              end
              
              Level.InitSearchScript(npc);
           
              Level.HadForbidObjects = Level.HasForbidObjects();
              Level.HadSuitcase      = Level.PlayerSuitcase;

           else
              Level.AddSmallMessage( MissionText.Message_StopMove_Search2, 5.0, 175, 175, 175 );
              AI.HandleVoice( npc, "male_usa_script_script_38");
           end
        else
           Level.AddSmallMessage( MissionText.Message_StopMove_Civilian, 5.0, 175, 175, 175 );
           AI.HandleVoice( npc, "male_usa_stopmove_stopmove_10");
        end
     
     elseif (zone == "NoWeapon") then
        
        Level.ClearSmallMessages();
        
        if (Level.PlayerSuitcase == false) then
           if (Level.HasForbidObjects() == true) then
              Level.AddSmallMessage( MissionText.Message_StopMove_Weapon, 5.0, 175, 175, 175 );
              AI.HandleVoice( npc, "male_usa_script_script_42");
           else
              Level.AddSmallMessage( MissionText.Message_StopMove_Strange, 5.0, 175, 175, 175 );
              AI.HandleVoice( npc, "@v_stop_move");
           end
        else
           Level.AddSmallMessage( MissionText.Message_StopMove_WeaponSuitcase, 5.0, 175, 175, 175 );
           AI.HandleVoice( npc, "male_usa_script_script_44");
        end
     
     elseif (zone == "ConstHouse") then

        Level.AddSmallMessage( MissionText.Message_StopMove_ConstHouse, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "male_usa_stopmove_stopmove_02");
        
     elseif (zone == "Floor1") then

        Level.AddSmallMessage( MissionText.Message_StopMove_Floor1, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "male_usa_stopmove_stopmove_10");

     elseif (zone == "Floor2") then

        if (playerForm == "Milkman") then
           Level.AddSmallMessage( MissionText.Message_StopMove_Floor2_MilkMan, 5.0, 175, 175, 175 );
           AI.HandleVoice( npc, "@v_stop_move");
        else
           Level.AddSmallMessage( MissionText.Message_StopMove_Floor2, 5.0, 175, 175, 175 );
           AI.HandleVoice( npc, "male_usa_stopmove_stopmove_10");
        end

     elseif (zone == "ShopStorage") then
        
        if (playerForm == "Policeman") then
           Level.AddSmallMessage( MissionText.Message_StopMove_ShopStorage_Policeman, 5.0, 175, 175, 175 );
           
           if (npcClass == "civilian_woman" or npcClass == "enemy_woman") then
              AI.HandleVoice( npc, "female_usa_stopmove_stopmove_06");
           else
              AI.HandleVoice( npc, "male_usa_stopmove_stopmove_11");
           end
           
        else
           Level.AddSmallMessage( MissionText.Message_StopMove_ShopStorage, 5.0, 175, 175, 175 );
           
           if (npcClass == "civilian_woman" or npcClass == "enemy_woman") then
              AI.HandleVoice( npc, "female_usa_stopmove_stopmove_06");
           else
              AI.HandleVoice( npc, "@v_stop_move");
           end           
        end

     elseif (zone == "Floor3") then
        
        Level.AddSmallMessage( MissionText.Message_StopMove_Floor3, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "@v_stop_move");

     elseif (zone == "House3_West") then
        
        Level.AddSmallMessage( MissionText.Message_StopMove_House3_West, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "@v_stop_move");
        
     elseif (zone == "House3_East") then
     
        Level.AddSmallMessage( MissionText.Message_StopMove_House3_East, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "male_usa_stopmove_stopmove_15");

     elseif (zone == "Kitchen") then
     
        Level.AddSmallMessage( MissionText.Message_StopMove_Kitchen, 5.0, 175, 175, 175 );
        
        if (npcClass == "civilian_woman" or npcClass == "enemy_woman") then
           AI.HandleVoice( npc, "female_usa_stopmove_stopmove_07");
        else
           AI.HandleVoice( npc, "male_usa_stopmove_stopmove_13");
        end

     elseif (zone == "Garage") then
     
        Level.AddSmallMessage( MissionText.Message_StopMove_Garage, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "male_usa_stopmove_stopmove_03");

     elseif (zone == "Floor2_Sklad") then
     
        Level.AddSmallMessage( MissionText.Message_StopMove_Floor2_Sklad, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "male_usa_stopmove_stopmove_08");

     elseif (zone == "BehindMainHouse") then
     
        Level.AddSmallMessage( MissionText.Message_StopMove_BehindMainHouse, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "male_usa_stopmove_stopmove_04");

     elseif (zone == "ShopStorageEnter") then
     
        Level.AddSmallMessage( MissionText.Message_StopMove_ShopStorageEnter, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "@v_stop_move");

     elseif (zone == "House3_EastEnter") then
     
        local playerRoom = Entity.GetRoomId( Level.GetPlayer() );
        if ( playerRoom == 'VA41' ) then
          Level.AddSmallMessage( MissionText.Message_StopMove_House3_EastEnter, 5.0, 175, 175, 175 );
          AI.HandleVoice( npc, "male_usa_stopmove_stopmove_14");
        else
          Level.AddSmallMessage( MissionText.Message_StopMove_House3_EastEnter2, 5.0, 175, 175, 175 );
          AI.HandleVoice( npc, "male_usa_stopmove_stopmove_15");
        end;
     end
     
  end

  --------------------------------------------------------
  -- Name: Level.OnDropBarels()
  -- Desc:
  --------------------------------------------------------
  function Level.OnDropBarels()
     local object = Level.FindWorldObject('BO06');
     if (object != nil) then
        Level.AddWorldObjectPhysicsForce(object, 1500.0, 0.0, 2800.0 );
     else
        print("Can't find object BO06");
     end
     
     Level.InstallDpc("Level.OnTeleportBarrels()", 3.0);
  end

  --------------------------------------------------------
  -- Name: Level.DebugStoreObjects()
  -- Desc:
  --------------------------------------------------------
  function Level.DebugPrintBarrels()
    
    Level.DebugPrintObjects( 'BO05' );
    Level.DebugPrintObjects( 'BO06' );
	
  end

  --------------------------------------------------------
  -- Name: Level.RestoreRamaPos()
  -- Desc:
  --------------------------------------------------------
  function Level.RestoreRamaPos()
    local obj = Level.FindWorldObject('RAMA');
    if (obj != nil) then
       Level.SetWorldObjectPos( obj, 433.26, 6.9665, -1245);
       Level.SetWorldObjectRot( obj, -40.339, 90.0, -90.0);
        
       Level.EnableWorldObjectPhysics(obj, false);
    end	
  end

  --------------------------------------------------------
  -- Name: Level.DebugPrintRama()
  -- Desc:
  --------------------------------------------------------
  function Level.DebugPrintRama()
    
    Level.DebugPrintObjects( 'RAMA' );

  end

  --------------------------------------------------------
  -- Name: Level.TeleportBarrel()
  -- Desc:
  --------------------------------------------------------
  function Level.TeleportBarrel( barrelId, pos, rot)
     local obj = Level.FindWorldObject(barrelId);
     if (obj != nil) then
        Level.SetWorldObjectPos( obj, pos.x, pos.y, pos.z);
        Level.SetWorldObjectRot( obj, rot.x, rot.y, rot.z);
        
        Level.EnableWorldObjectPhysics(obj, false);
        
        local x1, y1, z1, x2, y2, z2 = Level.GetWorldObjectAABB(obj);
        
        AI.AddScriptDynamicObstacle( barrelId, x1, y1, z1, x2, y2, z2 );
     end
  end

  --------------------------------------------------------
  -- Name: Level.EnableEntityCollision()
  -- Desc:
  --------------------------------------------------------
  function Level.OnTeleportBarrels()
     
     --Level.TeleportBarrel( 'BO05', {x=222.58, y=13.567, z=-1180.0}, {x=-9.7505, y=43.26, z=90.0});
     --Level.TeleportBarrel( 'BO06', {x=229.88, y=13.357, z=-1168.9}, {x=-15.074, y=-86.434, z=94.075});

     Level.TeleportBarrel( 'BO05', {x=224.33, y=13.566, z=-1203.9}, {x=-4.5157, y=113.43, z=89.896});
     Level.TeleportBarrel( 'BO06', {x=232.31, y=13.255, z=-1168.2}, {x=8.2284, y=-138.18, z=89.937});
     
  end  

  --------------------------------------------------------
  -- Name: Level.EnableEntityCollision()
  -- Desc:
  --------------------------------------------------------
  function Level.PreparePlate( entity )
     Level.EnableCollisionListener( entity, 2500.0, true );
     Level.EnableItemPickup( entity, false );
  end

  --------------------------------------------------------
  -- Name: Level.OnDropKitchenCabinet()
  -- Desc:
  --------------------------------------------------------
  function Level.OnDropKitchenCabinet()
     local object = Level.FindWorldObject('ET04');
     if (object != nil) then
        Level.AddWorldObjectPhysicsForce(object, 0.0, 0.0, 1500.0 );
     else
        print("Can't find object ET04");
     end
     
     Level.ForEachEntity("", "PreparePlate", 602.0657, 24.6189, -1085.7589, 608.0051, 35.6189, -1075.3240);
     
     Level.InstallDpc("Level.ExplodePlates()", 1.0);
     
     AI.AddScriptDynamicObstacle( 'KTCB', 599.5346, 9.0217, -1077.9480, 610.7667, 15.6906, -1057.1428 );
     AI.AddSoundFader('PLEX', "", 605.0, 14, -1065, 100.0, 200.0);
     
     Level.InstallDpc("Level.RunNpcJobs()", 1.3);
     
     Level.KabinetDroped = true;
     
     Level.EnableLevelMark('ETAS', false);
  end

  --------------------------------------------------------
  -- Name: Level.ExplodePlates()
  -- Desc:
  --------------------------------------------------------
  function Level.ExplodePlates()
     Level.ForEachEntity("", "Explode", 597.6186, 11.7056, -1073.2256, 612.2096, 16.7056, -1050.4746);
  end

  --------------------------------------------------------
  -- Name: Level.RunNpcJobs()
  -- Desc:
  --------------------------------------------------------
  function Level.RunNpcJobs()
     local fbi_man = AI.FindNPC('FB14');
     
     AI.SetJob(fbi_man, "wait");     
     if (AI.IsDefault(fbi_man) == true) then
        Level.RunAnchorJob(fbi_man, 'A171');
     end
     
     local women = AI.FindNPC('T208');
     AI.SetJob(women, "sweep");
     if (AI.IsDefault(women) == true) then
        Level.RunAnchorJob_Run(women, 'A211');
     end
     
     women = AI.FindNPC('T209');
     AI.SetJob(women, "wait");
     if (AI.IsDefault(women) == true) then
        Level.RunAnchorJob_Run(women, 'A210');
     end
     
     AI.RemoveSoundFader('PLEX');
  end

  --------------------------------------------------------
  -- Name: Level.OnBarelsMoveOut()
  -- Desc:
  --------------------------------------------------------
  function Level.OnBarelsMoveOut()
     local objectId = { 'BO05', 'BO06' };
     local forcey = { 0.0, 200.0 };
     for i in objectId do
        local object = Level.FindWorldObject(objectId[i]);
        if (object != nil) then
           Level.AddWorldObjectPhysicsForce(object, -1500.0, forcey[i], 0.0 );
        else
           print("Can't find object " .. objectId[i]);
        end
     end
  end
  
  --------------------------------------------------------
  -- Name: Level.OnStartPlayerCustomAnim()
  -- Desc:
  --------------------------------------------------------
  function Level.OnStartPlayerCustomAnim( animId )
     if (animId == 'DRBR') then
        Level.InstallDpc("Level.OnDropBarels()", 0.33);
        Level.InstallDpc("Level.OnBarelsMoveOut()", 3.0);
        
        Level.BarrelsDroped = true;
        
     elseif (animId == 'DFTC') then
        AI.StartDecamouflage( 50.0, 100.0, 2.0 );
        
        Level.InstallDpc("Level.OnDropKitchenCabinet()", 0.6);
        Level.InstallDpc("Level.PlayCustomSound('ShkafSnd')", 1.5 );
     
     elseif ( animId == 'BEXG' ) then
     
        Level.PlayCustomSound('GasOnSnd');
     
     elseif ( animId == 'BEXP' ) then
        
        Level.PlayCustomSound('KanistraOn' );
        
     elseif (animId == 'TRKT') then
        
        Level.LiftAnimating = true;
        Level.AddTimer('SLTM', "SwitchLift", 1.5, false);
        Level.EnableWorldObjectAnim( Level.FindWorldObject('RUCH'), true, 0.0, 143.0, 30.0 );
        Level.PlayCustomSound( 'LebedkaSnd' );
        
        if ( Level.LiftState == 0 ) then
          Level.InstallDpc( "Level.EnableWorldObjectAnim( Level.FindWorldObject('LEBD'), true, 0.0, 30.0, 30.0 )", 0.72 );
        else
          Level.InstallDpc( "Level.EnableWorldObjectAnim( Level.FindWorldObject('LEBD'), true, 32.0, 62.0, 30.0 )", 0.72 );
        end;
        
        -- Activate cutscene...
        Level.LiftCutscenes = Level.LiftCutscenes + 1;
        Level.BeginCutScene( "Lift" , "Levels\\Cowboy\\lift.scm", "", 3.5, { 1, 0.0, 50.0, 60.0, 255 } );
     end
  end;
    
  --------------------------------------------------------
  -- Name: Level.OnFinishPlayerCustomAnim()
  -- Desc:
  --------------------------------------------------------
  function Level.OnFinishPlayerCustomAnim(animName, animUniqueId, boolBreaked )
     
     if ( boolBreaked == true ) then
        
        Level.OnBreakActionTrigger();
        AI.StopDecamouflage();
        Level.StopAllCustomAnimSounds();

        return;
     end;

     if (animUniqueId == 'DRBR') then
     
     elseif ( animUniqueId == 'BEXP' or animUniqueId == 'BEXG' ) then

        Level.OnFinishCutScene( Level.FindCutScene("StartExplosion"), false, "StartExplosion" )     
        
     elseif (animUniqueId == 'DFTC') then
        
     elseif (animUniqueId == 'TRKT') then
        Level.RemoveTimer('SLTM');
        Level.LiftAnimating = false;
        Level.EnableWorldObjectAnim( Level.FindWorldObject('RUCH'), false );
        Level.EnableWorldObjectAnim( Level.FindWorldObject('LEBD'), false );
     end
               
     if ( Level.FinishAnimTrigger != "" and Level.FinishAnimUnregister == true ) then
     
         local t = Level.FindTrigger( Level.FinishAnimTrigger );
         if ( t != nil ) then
            Level.UnregisterTrigger( t );         
         end;
            
     end;
     
     Level.FinishAnimTrigger    = "";
     Level.FinishAnimUnregister = false;
     
     Level.PlayerAnimSounds     = {};
  end
 
  --------------------------------------------------------
  -- Name: Level.OnFinishCutScene()
  -- Desc:
  --------------------------------------------------------
  function Level.OnFinishCutScene( cutscene, boolBreaked, cutsceneName )
  
      local stopCutScene = true;
      
      --print('OnFinishCutScene = ' .. cutsceneName );
      
      if ( boolBreaked == true ) then
         if ( cutsceneName == "Explosion" and Level.CanDisableExplosion == false ) then
            stopCutScene = false;         
         end;
         
         if ( cutsceneName == "Board" or cutsceneName == "StartExplosion" or cutsceneName == "Lift" ) then
            stopCutScene = false;         
         end;      
      end;
      
      --print('Stop cutscene = ' .. tostring( stopCutScene ) );
      
      if ( stopCutScene == true ) then
         CutScene.Activate(nil);
      end;
      
      if (cutsceneName == "Lift" and boolBreaked == false ) then
         Level.LiftAnimating = false;
         Level.EnableWorldObjectAnim( Level.FindWorldObject('RUCH'), false );
         Level.EnableWorldObjectAnim( Level.FindWorldObject('LEBD'), false );         
      elseif (cutsceneName == "Board") then
         --Level.SetHudFadeOut(1);
         --Level.InstallDpc("Level.SetHudFadeIn(1)", 2.5);
      elseif (cutsceneName == "StartExplosion" and boolBreaked == false ) then
         Level.OnBeginExplosion();      
      elseif ( cutsceneName == "BoardDeform" ) then
         Level.HideWorldObject( 'BRDA' );
         Level.UpdateBoardDeformation(Level.BoardDeformation + 1);        
      end;
  end;
      
----------------------- Bot idles and ai scripts -----------------------------

--------------------------------------------------------
-- Name: Level.CheckAccidentState()
-- Desc:
--------------------------------------------------------
function Level.CheckAccidentState(id)
   return false;
end

--------------------------------------------------------
-- Name: Level.OnAccident()
-- Desc:
--------------------------------------------------------
function Level.OnAccident(id)
end

--------------------------------------------------------
-- Name: Level.HasForbidObjects()
-- Desc:
--------------------------------------------------------
function Level.HasForbidObjects()
   if (Level.PlayerSuitcase == true) then
      return true;
   end

--   local numKnifes = Actor.GetNumWeaponOfClass( Level.GetPlayer(), Level.WEAPON_CLASS_KNIFE, true );
--   if (numKnifes >= 1)
--      return true;
--   end
   
   local numPistols = Actor.GetNumWeaponOfClass( Level.GetPlayer(), Level.WEAPON_CLASS_PISTOL, true );
   if (numPistols >= 1) then
      return true;
   end
   
   local numRifles = Actor.GetNumWeaponOfClass( Level.GetPlayer(), Level.WEAPON_CLASS_RIFLE, true ) +
                     Actor.GetNumWeaponOfClass( Level.GetPlayer(), Level.WEAPON_CLASS_MACHINEGUN, true );
   if (numRifles >= 1) then
      return true;
   end

   return false;
end

--------------------------------------------------------
-- Name: Level.CanEnablePolicemanWeaponZone()
-- Desc:
--------------------------------------------------------
function Level.CanEnablePolicemanWeaponZone()
   local numRifles = Actor.GetNumWeaponOfClass( Level.GetPlayer(), Level.WEAPON_CLASS_RIFLE, true ) +
                     Actor.GetNumWeaponOfClass( Level.GetPlayer(), Level.WEAPON_CLASS_MACHINEGUN, true );
   if (numRifles >= 1) then
      return true;
   end
   
   return false;
end

--------------------------------------------------------
-- Name: Level.CheckEnablePolicemanZone()
-- Desc:
--------------------------------------------------------
function Level.CheckEnablePolicemanZone()

   AI.EnableZone("PolicemanWeaponZone", Level.CanEnablePolicemanWeaponZone());
end

--------------------------------------------------------
-- Name: Level.ResetSearchScript()
-- Desc:
--------------------------------------------------------
function Level.ResetSearchScript()
   Level.RemoveDpc("Level.EnableSearchZone()");
   
   AI.EnableZone("SearchZone_1", true);
   AI.EnableZone("SearchZone_2", true);
end

--------------------------------------------------------
-- Name: Level.EnableSearchZone()
-- Desc:
--------------------------------------------------------
function Level.EnableSearchZone()
   AI.EnableZone("SearchZone_1", true);
   AI.EnableZone("SearchZone_2", true);
   
   AI.EnableZone("NoWeapon", false);
   AI.EnableZone("NoWeapon", false);
end

--------------------------------------------------------
-- Name: Level.CanEnableSearchZone()
-- Desc:
--------------------------------------------------------
function Level.CanEnableSearchZone()
   --return (Level.AtSearchZone == false) or (Level.HasForbidObjects() == true);
   return (Level.AtSearchZone == false);
end

--------------------------------------------------------
-- Name: Level.CanEnableSearchZone2()
-- Desc:
--------------------------------------------------------
function Level.CanEnableSearchZone2()
   return (Level.AtSearchZone == false) or (Level.HasForbidObjects() == true);
end

--------------------------------------------------------
-- Name: Level.OnSearchFinished()
-- Desc:
--------------------------------------------------------
function Level.OnSearchFinished()
     --if (Level.HasForbidObjects() == true or Level.HadForbidObjects == true) then
     if (Level.HasForbidObjects() == true or Level.HadSuitcase == true) then
        
        Level.SearchTimes = Level.SearchTimes + 1;
        Level.InstallDpc("Level.SearchTimes = 0", 20.0);
        
        if (Level.SearchTimes > 1 and false) then
        --if (false)
           AI.DecamouflagePlayer(Level.GetSearchMan());
        else
           -- Level.AddSmallMessage( MissionText.Message_StopMove_Weapon, 5.0, 175, 175, 175 );
           
           AI.EnableZone("SearchZone_1", false);
           AI.EnableZone("SearchZone_2", false);

           AI.EnableZone("NoWeapon", true);
           
           Level.InstallSingleSmartDpc("Level.EnableSearchZone()", 5.0, "Level.CanEnableSearchZone2()");
        end
     else
        AI.EnableZone("SearchAlertZone", false);
        Level.AddSmallMessage( MissionText.Message_StopMove_Clean, 5.0, 175, 175, 175 );
        AI.HandleVoice( Level.GetSearchMan(), "male_usa_script_script_41");
        
        AI.EnableZone("SearchZone_1", false);
        AI.EnableZone("SearchZone_2", false);
        
        Level.InstallSingleSmartDpc("Level.EnableSearchZone()", 5.0, "Level.CanEnableSearchZone()");
        
        Level.SearchJustFinished = true;
        Level.InstallDpc("Level.SearchJustFinished = false", 15.0);
     end
end

--------------------------------------------------------
-- Name: Level.InitSearchScript()
-- Desc:
--------------------------------------------------------
function Level.InitSearchScript(npc)
     local properties = Level.CreateCustomParams();     
        
     Level.SetValue(properties, "CustomString_1", "PlayerFront" );
     Level.SetValue(properties, "CustomString_2", "Level.OnSearchFinished()" );
     Level.SetValue(properties, "CustomString_3", 'SRSC' );
     Level.SetValue(properties, "CustomString_4", "Act_Cowboy_SearchMan" );
     Level.SetValue(properties, "CustomString_5", "" );
     Level.SetValue(properties, "CustomString_6", "7.0" );

     AI.RunScriptTask(npc, "scripts:job\\LookObjectTask.lua", AI.LOGIC_DEFAULT, properties);

     Level.RemoveDpc("AI.EnableZone('SearchAlertZone', false)");
     Level.InstallDpc("AI.EnableZone('SearchAlertZone', false)", 50.0);
     
     Level.SearchingStart = true;
     Level.InstallDpc('Level.SearchingStart = true', 0.5);
end

--------------------------------------------------------
-- Name: Level.CheckLookObjectTaskCondition()
-- Desc:
--------------------------------------------------------
function Level.CheckLookObjectTaskCondition(npc, id) 
   if (id == 'SRSC') then
      local zone = AI.GetPrimaryPlayerZone( npc );
      return zone == Level.SearchZoneName;
   end
   
   return false;
end

--------------------------------------------------------
-- Name: Level.GetSearchMan()
-- Desc:
--------------------------------------------------------
function Level.GetSearchMan()
     
   local job = AI.GetScriptJob("TASK_SCRIPT_LOOK_OBJECT");
   if (job != nil) then
     return Job.GetNPC( job );
   end
     
   return nil; 
end


---------------------------------- Callbacks ---------------------------------

  --------------------------------------------------------
 
--------------------------------------------------------
-- Name: Level.OnInventoryChanged()
-- Desc:
--------------------------------------------------------
function Level.OnInventoryChanged()
print("Level.OnInventoryChanged()");
   Level.ResetSearchScript();
end

--------------------------------------------------------
-- Name: Level.EnableGasKanistaZone()
-- Desc:
--------------------------------------------------------
function Level.EnableGasKanistaZone( bOnOff )
   local dpcCommand = "AI.EnableZone( 'GasKanistraZone', false )";
   
   if (bOnOff == true) then
      AI.EnableZone( "GasKanistraZone", true );
      Level.RemoveDpc(dpcCommand);
   elseif (bOnOff == false) then
      Level.InstallDpc(dpcCommand, 4.0);
   end
end

--------------------------------------------------------
-- Name: Level.OnNotifyPickupItem()
-- Desc:
--------------------------------------------------------
function Level.OnNotifyPickupItem( objectId, object, actor )
   if (objectId == 'SC01' and actor == Level.GetPlayer()) then
      Level.PlayerSuitcase = true;
      Level.EnableLevelMark('SUIT', false);
      Level.EnableLevelMark('SUIF', false);
      Level.PlayerGotSuitcase = true;
      
      if (Level.AtPoliceZoneTrigger == true) then
         AI.StartDecamouflage( 85.0, 200.0, 7.0 );
      end
      
      return;
   end

   if (objectId == 'KN01' and actor == Level.GetPlayer()) then
      Level.PlayerKanistra = true;
      Level.EnableGasKanistaZone( true );
      Level.EnableLevelMark('KANS', false);   
      
      Level.KanistraAtRoom = false;   
      return;
   end

   if (objectId == 'GB01' and actor == Level.GetPlayer()) then
      Level.PlayerGasBalon = true;
      Level.EnableGasKanistaZone( true );
      return;
   end
   
   if (Level.GetDifficulty() > 0) then
      if (objectId == 'BD01' and actor == Level.GetPlayer()) then
         AI.OnPlayerEnterZone("MilkmanBidon", 'MLBD');
         Level.InstallSingleDpc("AI.OnPlayerLeaveZone('MilkmanBidon', 'MLBD')", 5.0);
      end
   end
end

--------------------------------------------------------
-- Name: Level.OnNotifyDropItem()
-- Desc:
--------------------------------------------------------
function Level.OnNotifyDropItem( objectId, object, actor )

   if ( Level.HideDropEntity == objectId ) then
      Entity.SetHidden( object, true );
      Level.EnableItemPickup( object, false );
   end;

   if (objectId == 'SC01' and actor == Level.GetPlayer()) then
      Level.PlayerSuitcase = false;
      
      if (Level.AtPutBodyTrigger == true) then
         Level.DiplomatAtRoom = true;
      end
      
      return;
   end

   if (objectId == 'KN01' and actor == Level.GetPlayer()) then
      Level.PlayerKanistra = false;
      Level.EnableGasKanistaZone( false );
      
      if (Level.AtPutBodyTrigger == true) then
         Level.KanistraAtRoom = true;
      end
      
      return;
   end

   if (objectId == 'GB01' and actor == Level.GetPlayer()) then
      Level.PlayerGasBalon = false;
      Level.EnableGasKanistaZone( false );
      
      if (Level.AtPutBodyTrigger == true) then
         Level.BalonAtRoom = true;
      end
            
      return;
   end

   if (Level.GetIndex(Level.Boxes, objectId) != -1) then
      if (Level.ActiveDropBoxAnchor != "" and
          Level.BoxesDroped[Level.ActiveDropBoxAnchor] != nil) then
          
          local vec = { x=0, y=(Level.BoxesDroped[Level.ActiveDropBoxAnchor] - 1) * 6.0, z=0 };
          Level.MoveItem( object, vec );
      end
   end
end

--------------------------------------------------------
-- Name: Level.OnAnchor_DropBox()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_DropBox(anchorId)
   Level.ActiveDropBoxAnchor = anchorId;
   
   if (Level.BoxesDroped[anchorId] == nil) then
      Level.BoxesDroped[anchorId] = 1;
   else
      Level.BoxesDroped[anchorId] = Level.BoxesDroped[anchorId] + 1;
   end
end

--------------------------------------------------------
-- Name: Level.NeedEnableMark()
-- Desc:
--------------------------------------------------------
function Level.NeedEnableMark(markId) 
   if (markId == 'ETAS') then
      return Level.KabinetDroped == false and Level.GetDifficulty() == 1;
   elseif (markId == 'LIFT') then
      return Level.GetDifficulty() == 1;
   elseif (markId == 'BARL') then
      return Level.BarrelsDroped == false and Level.GetDifficulty() < 2;
   end
end

--------------------------------------------------------
-- Name: Level:OnPlayerAction()
-- Desc:
--------------------------------------------------------
function Level:OnPlayerAction(id)
   
end

--------------------------------------------------------
-- Name: Level.OnTrigger_InitWorkers()
-- Desc:
--------------------------------------------------------
function Level.OnTrigger_InitWorkers()
   Level.InstallDpc("AI.SetJob(AI.FindNPC('CW02'), 'work')", 5.0);
   Level.InstallDpc("AI.SetJob(AI.FindNPC('CW03'), 'work')", 10.0);
   Level.InstallDpc("AI.SetJob(AI.FindNPC('CW04'), 'work')", 8.0);
   Level.InstallDpc("AI.SetJob(AI.FindNPC('CW05'), 'work')", 12.0);
end

--------------------------------------------------------
-- Name: Level.OnTrigger_StartFbiPolicemanJob()
-- Desc:
--------------------------------------------------------
function Level.OnTrigger_StartFbiPolicemanJob()
   if (Level.FbiPolicemanJobChanged == true) then
      return;
   end

   local policeMan = AI.FindNPC('PL04');
   local fbiMan    = AI.FindNPC('FB01');
   
   local runScript = false;
   if (AI.IsDefault(policeMan) and
       AI.IsDefault(fbiMan)) then
       
       runScript = true;
   end
   
   Level.ChangeFbiPolicemanJob();
   
   if (runScript == true) then
      Level.RunAnchorJob2(fbiMan, 'AN73', 'AN74', false);
      Level.RunAnchorJob(policeMan, 'AN75');
   end   
end

--------------------------------------------------------
-- Name: Level.StartCivilianIdleJob()
-- Desc:
--------------------------------------------------------
function Level.ChangeFbiPolicemanJob()
   if (Level.FbiPolicemanJobChanged == true) then
      return;
   end

   local policeMan = AI.FindNPC('PL04');
   local fbiMan    = AI.FindNPC('FB01');
   
   AI.SetJob(fbiMan, "patrol");
   AI.SetJob(policeMan, "patrol");
   
   Level.FbiPolicemanJobChanged = true;
end

--------------------------------------------------------
-- Name: Level.StartCivilianIdleJob()
-- Desc:
--------------------------------------------------------
  function Level.StartCivilianIdleJob()
       local bot = AI.FindNPC('CC06');
       if (bot != nil) then
          AI.SetJob(bot, "idle");
          Level.RunAnchorJob2(bot, 'AN83', 'AN84', true);
       end
  end

--------------------------------------------------------
-- Name: Level.OnDoFbiPatrol()
-- Desc:
--------------------------------------------------------
  function Level.OnDoFbiPatrol()
     local fbi1 = AI.FindNPC('FB12');
     local fbi2 = AI.FindNPC('FB13');
     
     if (AI.IsDefault(fbi1) == true and  
         AI.IsDefault(fbi2) == true) then
         
         Level.RunAnchorJob2(fbi1, 'A107', 'A109', true);
         Level.RunAnchorJob2(fbi2, 'A106', 'A108', true);
     
     end
  end

--------------------------------------------------------
-- Name: Level.OnOfficerAnswer()
-- Desc:
--------------------------------------------------------
  function Level.OnOfficerAnswer()
     local policeman = AI.FindNPC('PL11');
     Level.RunAnchorJob(policeman, 'A119');
     --Level.VoiceMessage(policeman, "Sound_IDontKnow", "Message_IDontKnow");
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_TalkToPoliceman()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_TalkToPoliceman()
     local girl      = AI.FindNPC('T206');
     local policeman = AI.FindNPC('PL11');
     
     if (AI.IsDefault(girl) == true and AI.IsDefault(policeman) == true) then
        --Level.VoiceMessage(girl, "Sound_WhenItWillFinish", "Message_WhenItWillFinish");
        Level.InstallDpc("Level.OnOfficerAnswer()", 1.0);
        
        if (Level.LineInvestigated == false and Level.GetDifficulty() <= 1) then
           Level.InstallDpc("Level.RunAnchorJob(AI.FindNPC('PL11'), 'A162')", 10.0);
        end
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_DropMilk()
-- Desc:
--------------------------------------------------------
  function Level.OnTrigger_StartMilkMan()
     local milkman = AI.FindNPC('ML01');
     AI.SetJob(milkman, "move");
  end

--------------------------------------------------------
-- Name: Level.UpdateLebedka()
-- Desc:
--------------------------------------------------------
  function Level.UpdateLift( state )
     Level.LiftState = state;
     
     if (state == 1) then 
        Level.HideWorldObject( 'LB01' );
        Level.ShowWorldObject( 'LB02' );
        
        Level.ForEachEntity("", "MoveUp", 243.3689 + 2.0, 6.0, -1089.1886 + 2.0, 264.3689 - 2.0, 17.9450, -1078.1886 - 2.0);
     else
        Level.HideWorldObject( 'LB02' );
        Level.ShowWorldObject( 'LB01' );
        
        Level.ForEachEntity("", "MoveDown", 243.3689 + 2.0, 104.0, -1089.1886 + 2.0, 264.3689 - 2.0, 115.1667, -1078.1886 - 2.0);
     end
  end

--------------------------------------------------------
-- Name: Level.SwitchLift()
-- Desc:
--------------------------------------------------------
  function Level.SwitchLift()
     if (Level.LiftState == 1) then
        Level.UpdateLift(0);
     else
        Level.UpdateLift(1);
     end
  end

--------------------------------------------------------
-- Name: Level.MoveUp()
-- Desc:
--------------------------------------------------------
  function Level.MoveUp( entity )
     local n = Entity.GetNode( entity );

     local x, y, z;
     x, y, z = node.GetPosition( n );
     local box = { 243.3689, 0.0, -1089.1886, 
                   264.3689, 17.9450, -1078.1886 };
     local pos = {};
     pos.x = x;
     pos.y = y;
     pos.z = z;
     if (Level.IsAtBBox(box, pos) == false) then
        return;
     end
     
     node.SetPosition( n, x, y + 97.28, z );
     node.InvalidateTransforms( n , true );
  end

--------------------------------------------------------
-- Name: Level.MoveDown()
-- Desc:
--------------------------------------------------------
  function Level.MoveDown( entity )
     local n = Entity.GetNode( entity );

     local x, y, z;
     x, y, z = node.GetPosition( n );
     node.SetPosition( n, x, y - 97.28, z );
     node.InvalidateTransforms( n , true );
  end
  
--------------------------------------------------------
-- Name: Level.OnFbiGoFirstFloor()
-- Desc:
--------------------------------------------------------
  function Level.OnFbiGoFirstFloor()
     local fbi_1 = AI.FindNPC('FB16');
     local fbi_2 = AI.FindNPC('FB17');
     
     if (AI.IsDefault(fbi_1) == true and
         AI.IsDefault(fbi_2) == true) then
        
        Level.RunAnchorJob(fbi_1, 'AN71', false);
        Level.RunAnchorJob(fbi_2, 'AN72', false);
     end
  end

--------------------------------------------------------
-- Name: Level.OnPolicemanBodyInfo()
-- Desc:
--------------------------------------------------------
  function Level.OnPolicemanBodyInfo( body )
  
     local id = Entity.GetUniqueIDAsString( body );

     if (Level.PolicemanInvestigated == true) then
        return;
     end
     
     if (id == 'CW01' or id == 'CW02' or id == 'CW03' or id == 'CW04') then
        local info = Level.GetDeadBodyInfo(body);
        
          if (info.accident == true) then
           
           local properties = Level.CreateCustomParams();

           Level.SetValue(properties, "CustomString_1", 'A177' );
           Level.SetValue(properties, "CustomString_2", 'A176' );
           Level.SetValue(properties, "CustomString_3", 'A178' );
           Level.SetValue(properties, "CustomString_4", 'A179' );
           Level.SetValue(properties, "CustomString_5", 'A180' );
  
           AI.RunScriptTask(AI.FindNPC('PL01'), "scripts:job\\AnchorJob5_safe.lua", AI.LOGIC_DEFAULT, properties);
           
           Level.PolicemanInvestigated = true;
        end     
     end
  end
  
--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor221()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor221()
    local fbiman  = AI.FindNPC('FB05');
    local milkman = AI.FindNPC('ML01');
    
    if (AI.IsDefault(fbiman) == true) then
       AI.TaskCommand(milkman, "current_anchor_completed", "", "");
       Level.RunAnchorJob(milkman, 'A186', false);
       Level.RunAnchorJob3(fbiman, 'A185', 'A187', 'A188', false);
    end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor151()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor151()
     local milkman = AI.FindNPC('ML01');
     
     if (Level.IsMissionTaskCompleted('RESC') == false and
         Level.IsMissionTaskCompleted('BODY') == false and
         Level.SpyAtRoom == true) then
         
         AI.SetJob(milkman, "wait_first");
         
     else
        AI.SetJob(milkman, "wait");
     end
  end
  
--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor151()
-- Desc:
--------------------------------------------------------
  function Level.UpdatePoliceLineState( state )
     if (state == 1) then
        --Level.HideWorldObject( 'PLL1' );
        --Level.ShowWorldObject( 'PLL2' );
        
        -- Add custom object...
        AI.AddCustomObject('PLLN', 996.75, 25.52, -1896.86, true);
        
        AI.RegisterClosedDoor( Level.FindDoor('DR12'), false );
        Level.PoliceLineCutted = true;
        
        AI.RemoveScriptDynamicObstacle( 'POLN' );
        Level.EnableWorldObjectAnim( Level.FindWorldObject('POLL'), true, 0.0, 33.0, 55.0, 0.0, false );
     else
        --Level.HideWorldObject( 'PLL2' );
        --Level.ShowWorldObject( 'PLL1' );
     end
  end
  
 
--------------------------------------------------------
-- Name: Level.OnOpenDoor()
-- Desc:
--------------------------------------------------------
function Level.OnOpenDoor( door )
   if ( door == 'DR12' ) then
      if ( Level.PoliceLineCutted == false ) then
         Level.UpdatePoliceLineState( 1 );
      end;      
   elseif (door == 'DR08') then
      AI.RegisterClosedDoor( Level.FindDoor('DR08'), false );
      AI.RemoveScriptDynamicObstacle( 'DR08' );
      Level.Door08Closed = false;
   elseif (door == 'DR15') then
      Level.SpyDoorLocked = false;
   elseif (door == 'DR01') then
      AI.RemoveScriptDynamicObstacle( 'DR01' );
   elseif ( door == 'FD03' ) then
      AI.RemoveScriptDynamicObstacle( 'FD03' );
   end;
end

--------------------------------------------------------
-- Name: Level.OnCloseDoor()
-- Desc:
--------------------------------------------------------
function Level.OnCloseDoor( door )
end

--------------------------------------------------------
-- Name: Level.CanEscort()
-- Desc:
--------------------------------------------------------
function Level.CanEscort( doorNum ) 
   if (Level.GetDifficulty() == 0) then
      return false;
   end
   
   if (Level.SearchJustFinished == false) then
      return false;
   end
   
   local playerForm = AI.GetPlayerForm();
   if (playerForm != "Policeman" and playerForm != "Milkman") then
      return false;
   end
   
   if (Level.GetCurrentEscortMan() != nil) then
      return false;
   end  
   
   return true;
end

--------------------------------------------------------
-- Name: Level.GetCurrentEscortMan()
-- Desc:
--------------------------------------------------------
function Level.GetCurrentEscortMan()
   for i in Level.FbiFollowDoor1 do
      local npc = AI.FindNPC(Level.FbiFollowDoor1[i]);
      if (AI.IsFollowingActor(npc, Level.GetPlayer()) == true or
          AI.HasTask(npc, AI.TASK_FOLLOW_ACTOR) == true) then
         return npc;
      end
   end
   
   for i in Level.FbiFollowDoor2 do
      local npc = AI.FindNPC(Level.FbiFollowDoor2[i]);
      if (AI.IsFollowingActor(npc, Level.GetPlayer()) == true or
          AI.HasTask(npc, AI.TASK_FOLLOW_ACTOR) == true) then
         return npc;
      end
   end
   
   return nil;
end

--------------------------------------------------------
-- Name: Level.GetEscortMan()
-- Desc:
--------------------------------------------------------
function Level.GetEscortMan(doorNum)
   if (doorNum == 1) then
      for i in Level.FbiFollowDoor1 do
         local npc = AI.FindNPC(Level.FbiFollowDoor1[i]);
         if (AI.IsDefault(npc) == true) then
            return npc;
         end
      end
   else
      for i in Level.FbiFollowDoor2 do
         local npc = AI.FindNPC(Level.FbiFollowDoor2[i]);
         if (AI.IsDefault(npc) == true) then
            return npc;
         end
      end
   end
   
   return nil;
end

--------------------------------------------------------
-- Name: Level.OnEnterEscortTrigger()
-- Desc:
--------------------------------------------------------
function Level.OnEnterEscortTrigger(doorNum)
   if (Level.CanEscort(doorNum) == false) then
      return;
   end
   
   local escortMan = Level.GetEscortMan(doorNum);
   if (escortMan == nil) then
      return;
   end
   
   local player = Level.GetPlayer();
   
   local properties = {};
   properties["DistanceRun"]        = true;
   properties["ParentPolicy"]       = true;
   properties["WatchCommander"]     = true;
   properties["TurnCommander"]      = true;
   properties["RaisedWeapon"]       = false;
   properties["CheckDistanceCoeff"] = 0.4;

   AI.FollowActor( escortMan, player, 0.0, -15.0, Level.ToCustomParams(properties));
   Level.EscortPlayerForm = AI.GetPlayerForm();

   Level.AddTimer( 'CHES', "OnCheckEscort", 1.0, true );
end

--------------------------------------------------------
-- Name: Level.OnCheckEscort()
-- Desc:
--------------------------------------------------------
function Level.OnCheckEscort()
   local player = Level.GetPlayer();
   
   if (Level.SearchJustFinished == true) then
      return;
   end
   
   if (Level.IsPlayerOutdoor() == true or
       (AI.GetPlayerForm() != Level.EscortPlayerForm)) then
       
      local escort = Level.GetCurrentEscortMan();
      if (escort == nil) then
         return;
      end
      
      Level.RemoveTimer( 'CHES' );
      AI.FailTask( escort, AI.TASK_FOLLOW_ACTOR );
   end
end

--------------------------------------------------------
-- Name: Level.SetupSaySpyScript()
-- Desc:
--------------------------------------------------------
function Level.SetupSaySpyScript( npc, msg )
   local job = AI.GetScriptJob("TASK_SCRIPT_CALL_ALERT");
   if (job != nil) then
       return false;
   end
   
   if (Level.SaySpyPhoneAnchors == nil) then
      return false;
   end
   
   assert(npc != nil, "");
   local anchorId = Level.FindNearestAnchor(Level.SaySpyPhoneAnchors, Level.GetNpcPosition(npc));
       
   if (anchorId == nil) then
      return false;
   end
   
   local anchor = AI.FindAnchor(anchorId);
          
   if (anchor == nil) then
      return false;
   end
          
   if (AI.IsAnchorBinded(anchor) == true) then
      return false;
   end
          
   AI.Debug(npc, "See custom actor alert", anchorId);
          
   AI.AnchorBindProtect(anchor, true);

   local properties = Level.CreateCustomParams();
   Level.SetValue(properties, "CustomString_1", anchorId );
		
   Level.AddSmallMessage( msg, 10.0, 255, 0, 0);
      
   Actor.MarkAsTarget( AI.GetActor(npc), true );
   AI.RunScriptTask(npc, "scripts:job\\CallAlert.lua", AI.LOGIC_NEUTRAL, properties);
   
   return true;
end

--------------------------------------------------------
-- Name: Level.OnCheckEscort()
-- Desc:
--------------------------------------------------------
function Level.OnSeeCustomActor(npc, actor)
   AI.Debug(npc, "Level.OnSeeCustomActor", "");
   
   local npcForm = AI.GetForm(npc);
   if (npcForm != "Fbi") then
      return;
   end
   
   local actorPos = Level.GetEntityPosition( actor );
   local npcPos   = Level.GetNpcPosition( npc );
   local distance = Level.BalanceDistance( npcPos, actorPos );
   
   if (distance < 200.0) then
      AI.SetScriptThreat( npc, 1.0, true, 0.0 );
      
      Level.SetupSaySpyScript( npc, MissionText.Message_SpyAlert );
   else
   
      local job = AI.GetScriptJob("TASK_SCRIPT_CALL_ALERT");
      if (job == nil) then
         local threat = saturate(1.0 - (distance - 200.0) / 2000.0);
         local oldThreat = AI.GetScriptThreat( npc );

         threat = saturate(threat + oldThreat);
         AI.SetScriptThreat( npc, threat, true, 0.2 );

         if (threat >= 0.98) then
            Level.SetupSaySpyScript( npc, MissionText.Message_SpyAlert );
         end
      end
   end
end

--------------------------------------------------------
-- Name: Level.OnSeeSpyRoom()
-- Desc:
--------------------------------------------------------
function Level.OnSeeSpyRoom(npc)
   if (Level.RoomInvestigating == true) then
      return;
   end
   
   if (Level.GetDifficulty() == 0) then
      return;
   end
   
   local npcForm = AI.GetForm(npc);
   if (npcForm != "Fbi") then
      return;
   end
   
   if (AI.IsImportantTask(npc) == true) then
      return;
   end
   
   Level.RunAnchorJob_Run(npc, 'A260', true);
   Level.RoomInvestigating = true;
end

--------------------------------------------------------
-- Name: Level.OnSeePoliceLine()
-- Desc:
--------------------------------------------------------
function Level.OnSeePoliceLine(npc)
   if (Level.LineInvestigated == true) then
      return;
   end
   
   if (Level.GetDifficulty() == 0) then
      return;
   end
   
   if (npc != AI.FindNPC('PL10')) then
      return;
   end
   
   Level.RunAnchorJob2(npc, 'A261', 'A262', true);   
   
   Level.LineInvestigated = true;
end

--------------------------------------------------------
-- Name: Level.OnSeeCustomObject()
-- Desc:
--------------------------------------------------------
function Level.OnSeeCustomObject(npc, objectId)
   AI.Debug(npc, "Level.OnSeeCustomObject", tostring(objectId));
   
   if (objectId == 'SPRM') then
      Level.OnSeeSpyRoom(npc);
   elseif (objectId == 'PLLN') then
      Level.OnSeePoliceLine(npc);
   end
end

--------------------------------------------------------
-- Name: Level.OnNotifyVisitedBody()
-- Desc:
--------------------------------------------------------
function Level.OnNotifyVisitedBody(npc, body, accident)
   local npcForm = AI.GetForm(npc);
   if (npcForm != "Fbi") then
      return;
   end

   if (body == Level.FindActor('FSPY')) then
      Level.SetupSaySpyScript( npc, MissionText.Message_SpyBodyAlert );
   end
end

--------------------------------------------------------
-- Name: Level.OnSaySpyInfo()
-- Desc:
--------------------------------------------------------
function Level.OnSaySpyInfo()
   Level.FailedMission( MissionText.Message_FailSaySpy, 15.0 );
end 

--------------------------------------------------------
-- Name: Level.OnLeaveTriggerArea()
-- Desc:
--------------------------------------------------------
  function Level.OnCheckPutBody()
     if (Level.IsMissionTaskCompleted('BODY') == false) then
        local body = Level.FindActor('BODY');
        local pos = Level.GetEntityPosition(body);
        local bbox = { 486.5078, 107.2109, -1309.7562,
                       561.5078, 132.2108, -1219.7562 };
                       
        if (Level.IsAtBBox(bbox, pos) == true) then
           Level.FinishTask('BODY');
           Level.RemoveTimer('PBTM');
        end
     else
        Level.RemoveTimer('PBTM');
     end
  end

--------------------------------------------------------
-- Name: Level.OnExitCheckSpy()
-- Desc:
--------------------------------------------------------
  function Level.OnExitCheckSpy()
     if (Level.IsMissionTaskCompleted('RESC') == false) then
        local spy = Level.FindActor('FSPY');
        local pos = Level.GetEntityPosition(spy);
        local bbox = { -371.3533, -0.1384, -1468.1798,
                       -301.3533, 24.8616, -1408.1798 };

        if (Level.IsAtBBox(bbox, pos) == true) then
           Level.FinishTask('RESC');
           Level.RemoveTimer('EXCS');
        end
     else
        Level.RemoveTimer('EXCS');
     end
  end

--------------------------------------------------------
-- Name: Level.OnKillSpy()
-- Desc:
--------------------------------------------------------
  function Level.OnKillSpy()
     Level.FailedMission( MissionText.Message_FailSpyDied, 15.0 );
  end

--------------------------------------------------------
-- Name: Level.OnHitSpy()
-- Desc:
--------------------------------------------------------
  function Level.OnHitSpy()
     if (Level.SpyAtRoom == true) then
        Level.FailedMission( MissionText.Message_FailSpyHit, 15.0 );
     end
     
     Level.AgentHitted = true;
  end

--------------------------------------------------------
-- Name: Level.HackGoWithMe()
-- Desc:
--------------------------------------------------------
  function Level.HackGoWithMe()
     local npc = AI.FindNPC('FSPY');
     if (npc != nil) then
        local properties = {};
        properties["DistanceRun"]        = true;
        properties["ParentPolicy"]       = true;
        properties["WatchCommander"]     = true;
        properties["TurnCommander"]      = true;
        properties["RaisedWeapon"]       = false;
        properties["CheckDistanceCoeff"] = 0.4;

        AI.FollowActor( npc, Level.GetPlayer(), 0.0, -20.0, Level.ToCustomParams(properties));
     end
  end

--------------------------------------------------------
-- Name: Level.CheckObjectsTrigger()
-- Desc:
--------------------------------------------------------
  function Level.CheckObjectsTrigger()
  end

--------------------------------------------------------
-- Name: Level.OnChangeSpyDialogCamera()
-- Desc:
--------------------------------------------------------
  function Level.OnChangeSpyDialogCamera()
     local npc = AI.FindNPC('FB30');
     if (npc != nil) then
        if (Level.IsUsingAnchor(npc, 'A169') == true) then
           Level.ChangeCamCutScene( "SpyDialog", "Levels\\Cowboy\\Tualet.scm", { 3, 0.0, 40.0, 70.0, 255 } );
        elseif (Level.IsUsingAnchor(npc, 'A170') == true) then
           Level.ChangeCamCutScene( "SpyDialog", "Levels\\Cowboy\\Tualet2.scm", { 3, 20.0, 40.0, 80.0, 255 } );
        elseif (Level.IsUsingAnchor(npc, 'AD02') == true or
                Level.IsUsingAnchor(npc, 'AD03') == true or
                Level.IsUsingAnchor(npc, 'AD01') == true) then
           Level.ChangeCamCutScene( "SpyDialog", "Levels\\Cowboy\\Door.scm", { 3, -60.0, 60.0, 70.0, 255 } );
        else
           Level.ChangeCamCutScene( "SpyDialog", "Levels\\Cowboy\\Room.scm", { 1, 0.0, 120.0, 200.0, 255 } );
        end
     end
  end

--------------------------------------------------------
-- Name: Level.StartSpyDialog()
-- Desc:
--------------------------------------------------------
  function Level.StartSpyDialog()
  
    if (AI.FindNPC('FB30') != nil) then
        local messages = { "",
                           MissionText.Message_SpyDialog,
                           MissionText.Message_SpyDialog };
    
        Level.BeginCutScene("SpyDialog", "Levels\\Cowboy\\SpyDialog.scm", messages, 8.0, { 3, 0.0, 50.0, 100.0, 255 } );
        Actor.MarkAsTarget( Level.FindActor('FB30'), true );
        
        Level.SpyMessageState = 0;
     else
        if (Level.SpyDoorLocked == false or Level.Door08Closed == false) then
           Level.BeginCutScene("SpyDialog", "Levels\\Cowboy\\SpyDialog.scm", MissionText.Message_SpyDialog_NoGuard, 6.0, { 3, 0.0, 50.0, 100.0, 255 } );
           
           Level.SpyMessageState = 1;
        else
           Level.BeginCutScene("SpyDialog", "Levels\\Cowboy\\SpyDialog.scm", MissionText.Message_SpyDialog_DoorLocked, 6.0, { 3, 0.0, 50.0, 100.0, 255 } );
           
           Level.SpyMessageState = 2;
        end
     end
     
     Level.InstallDpc("Level.OnChangeSpyDialogCamera()", 4.0);
     
     local spy = AI.FindNPC('FSPY');
     NPC.SetFlag(actor, NPC.F_IGNORE_OBSTACLES, true);
     Level.RunAnchorJob(spy, 'A239', true);
     
     Level.CanStartResqueAfterDialog = false;
     Level.InstallDpc("Level.CanStartResqueAfterDialog = true", 5.0);
     
     Level.SpyDialog = true;
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor_A239()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor_A239()
     local npc = AI.FindNPC('FSPY');
     
     if     (Level.SpyMessageState == 0) then
        AI.HandleVoice(npc, "%Script01_Sound");
     elseif (Level.SpyMessageState == 1) then
        AI.HandleVoice(npc, "%Script02_Sound");
     elseif (Level.SpyMessageState == 2) then
        AI.HandleVoice(npc, "%Script03_Sound");
     end
  end

--------------------------------------------------------
-- Name: Level.CanStartSpyDialog()
-- Desc:
--------------------------------------------------------
  function Level.CanStartSpyDialog()
     local room = Level.GetRoom('VA62');
     local npc = AI.FindNPC('FSPY');
     
     return Level.IsMissionTaskCompleted('RESC') == false and
            AI.GetRoom(npc) == room and
            Level.SpyAtRoom == true and
            Level.SpyDialog == false and
            AI.IsScriptTask(npc) == false and
            AI.HasPlayerInfo("Fbi", "knowposition") == false;
  end

--------------------------------------------------------
-- Name: Level.StartSpyResqueScript()
-- Desc:
--------------------------------------------------------
  function Level.StartSpyResqueScript()
     -- print("Level.StartSpyResqueScript()");

     -- local properties = Level.CreateCustomParams();

     -- Level.SetValue(properties, "CustomString_1", 'A240' );
     -- Level.SetValue(properties, "CustomString_2", 'A241' );
     -- Level.SetValue(properties, "CustomString_3", 'A242' );
     -- Level.SetValue(properties, "CustomString_4", 'A243' );
     -- Level.SetValue(properties, "CustomString_5", 'A244' );
  
     -- AI.RunScriptTask(AI.FindNPC('FSPY'), "scripts:job\\AnchorJob5_safe.lua", AI.LOGIC_NEUTRAL, properties);
     
     -- Set door locked == false...
     Level.SetDoorLockedId('DR15', false);
     
     local properties = Level.CreateCustomParams();
     Level.SetValue(properties, "CustomString_1", 'A245' );
     AI.RunScriptTask(AI.FindNPC('FSPY'), "scripts:job\\AnchorJob_safe_run.lua", AI.LOGIC_NEUTRAL, properties);
     
     CutScene.Activate(nil);
     
     Level.InstallDpc("Level.StartBalkonCutscene()", 3.0);
     
     Level.SpyAtRoom = false;
     
     AI.SetWatchActor( Level.FindActor('FSPY') );
     
     Level.ChangeFbiPolicemanJob();
  end

--------------------------------------------------------
-- Name: Level.StartBalkonCutscene()
-- Desc:
--------------------------------------------------------
  function Level.StartBalkonCutscene()
    Level.BeginCutScene("Board", "Levels\\Cowboy\\BalkonBoard.scm", "", 32.0, { 1, 0, 170.0, 220.0, 255 } );   
  end

--------------------------------------------------------
-- Name: Level.CanStartSpyResqueScript()
-- Desc:
--------------------------------------------------------
  function Level.CanStartSpyResqueScript()
     local guard = AI.FindNPC('FB30');
     local npc = AI.FindNPC('FSPY');
    
     return Level.IsMissionTaskCompleted('RESC') == false and
            npc != nil and
            Level.SpyDialog == true and
            Level.SpyAtRoom == true and
            AI.HasPlayerInfo("Fbi", "knowposition") == false and
            (guard == nil or Level.GetNpcPosition(guard).y < 90.0) and
            Level.CanStartResqueAfterDialog == true and
            (Level.SpyDoorLocked == false or Level.Door08Closed == false);
  end

--------------------------------------------------------
-- Name: Level.CanStartSpyResqueScript()
-- Desc:
--------------------------------------------------------
  function Level.UpdateBoard(state)
      Level.BoardState = state;
      Level.SwitchModel('BRD1', 'BRD2', state);
      
      if (state == 1) then
         AI.RemoveScriptDynamicObstacle( 'BORD' );
      end
  end
  
--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor245()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor245()
     -- Initialize script job
     local spy = AI.FindNPC('FSPY');
     if (spy != nil) then
        AI.SetJob(spy, "temp");

        AI.RunScriptTask(spy, "game:Levels\\Cowboy\\Jobs\\UseBoardTask.lua", AI.LOGIC_DEFAULT, nil);
     end
  end

--------------------------------------------------------
-- Name: Level.OnBeginBoardGet()
-- Desc:
--------------------------------------------------------
  function Level.OnBeginBoardGet()
     
     -- Level.InstallDpc("Level.UpdateBoard(1)", 0.70);
               
     Level.ChangeCamCutScene( "Board", "Levels\\Cowboy\\GetBoard.scm", { 1, 0.0, 70.0, 100.0, 255 } );
     --Level.InstallDpc("Level.OnChangeSpyState(1)", 10.0);
     --Level.InstallDpc("Level.OnChangeSpyState(2)", 18.0);
     
     Level.InstallDpc("Level.OnChangeSpyState(1)", 3.0);
     Level.InstallDpc("Level.OnChangeSpyState(2)", 6.0);
     Level.InstallDpc("Level.SetHudFadeOut(0.75)", 2.2 );
  end

--------------------------------------------------------
-- Name: Level.OnChangeSpyState()
-- Desc:
--------------------------------------------------------
  function Level.OnChangeSpyState(stateId)
     if (stateId == 1) then
        local job = AI.GetScriptJob("TASK_SCRIPT_USE_BOARD");
        if (job != nil) then
           Job.SendMessage( job, fourCC2int('STT1'), 0, 0 );
        end
     
        Level.UpdateBoard(1);
     
        Level.ChangeCamCutScene( "Board", "Levels\\Cowboy\\BalkonBoard.scm", { 1, 0, 120.0, 200.0, 255 } );
        Level.SetHudFadeIn(0.5);
        
     elseif (stateId == 2) then
        -- Finish cutscene...
        local job = AI.GetScriptJob("TASK_SCRIPT_USE_BOARD");
        if (job != nil) then
           Job.SendMessage( job, fourCC2int('STT2'), 0, 0 );
        end
        
        Level.StopCutscene( "Board" );
        
        AI.SetJob(AI.FindNPC('FSPY'), "waitplayer");
        NPC.SetFlag(actor, NPC.F_IGNORE_OBSTACLES, false);
        Level.RunAnchorJob3_Run(AI.FindNPC('FSPY'), 'A243', 'A244', 'A246', true);
        
        Level.AddPlayerActorAction( 'MOVE', 'FSPY', MissionText.Message_Move, "OnActorPlayerAction" , false, true );
        
        Level.CloseDoor( Level.FindDoor('DR15'), true, Level.GetPlayer() );
        -- TODO. Add close door by time
     end
  end

--------------------------------------------------------
-- Name: Level.OnActorPlayerAction()
-- Desc:
--------------------------------------------------------
  function Level.OnActorPlayerAction( actionId )
    if (Level.IsMissionTaskCompleted('RESC') == true) then
       return;
    end
    
    if ( actionId == 'MOVE' ) then
      if ( Level.SpyPlayerMove == false ) then
         Level.SpyFollowPlayer( false );
      else
         Level.SpyFollowPlayer( true );
      end;
    end;    
  end;

--------------------------------------------------------
-- Name: Level.SpyFollowPlayer()
-- Desc:
--------------------------------------------------------
  function Level.SpyFollowPlayer( bWait ) 
    local spy = AI.FindNPC('FSPY');
    local player = Level.GetPlayer();
    
    if (Level.IsMissionTaskCompleted('RESC') == true) then
       return;
    end
    
    if (spy == nil) then
       return;
    end
    
    if (bWait == false) then
      Level.SpyPlayerMove = true;
      Level.SetPlayerActorActionDesc( 'MOVE', MissionText.Message_Stop ); 
    else
      Level.SpyPlayerMove = false;
      Level.SetPlayerActorActionDesc( 'MOVE', MissionText.Message_Move );
    end

    if (spy != nil and player != nil) then
      if (AI.IsFollowingActor(spy, player) != false) then
         AI.EnableFollowActorPause(spy, bWait);
      else
        local properties = Level.CreateCustomParams();
        Level.SetValue(properties, "DistanceRun", true);
        Level.SetValue(properties, "ParentPolicy", true);
        Level.SetValue(properties, "KneelStandPolicy", true);
        Level.SetValue(properties, "FollowActorPause", bWait);
        Level.SetValue(properties, "CriticPathDistance", 200.0);
        Level.SetValue(properties, "CheckDistanceCoeff", 0.3);

        AI.FollowActor( spy, player, 0.0, -10.0, properties);
      end
    end
    
    if (spy != nil and bWait == false) then
       if (Level.GetDifficulty() == 1) then
          AI.EnableZone("ChWorkerFbiZone", true);
       end
       
       AI.OnPlayerEnterZone("PlayerSpyZone", 'PSZN');
    else
       if (Level.GetDifficulty() == 1) then
          AI.EnableZone("ChWorkerFbiZone", false);
       end
    
       AI.OnPlayerLeaveZone("PlayerSpyZone", 'PSZN');
    end

  end

--------------------------------------------------------
-- Name: Level.OnAnchor_GetBoard()
-- Desc:
--------------------------------------------------------
  function Level.OnFollowWaitThink()
     local npcPos    = Level.GetNpcPosition(AI.FindNPC('FSPY'));
     local playerPos = Level.GetPlayerPosition();
     local dist      = Level.BalanceDistance(npcPos, playerPos);
     
     if (dist < 70.0) then
        Level.VoiceMessage(AI.FindNPC('FSPY'), "%Script06_Sound", "Message_ICantGo");
     end
     
     if (dist > 40.0) then
        Level.AddSmallMessage( MissionText.Message_SpyWaitThink, 10.0, 255, 255, 255 );
     end
  end

--------------------------------------------------------
-- Name: Level.StartFireCutScene()
-- Desc:
--------------------------------------------------------
  function Level.StartFireCutScene(tm)
     -- print("Level.StartFireCutScene");
     
     if (Level.PlayerGasBalon == false and
         Level.PlayerKanistra == false and
         Level.PlayerSuitcase == false) then
        return;
     end
     
     --if (Level.PlayerGasBalon == true) then
        --Actor.DropPickupItem( Level.GetPlayer(), false );
     --end
     
     --if (Level.PlayerKanistra == true) then
        --Actor.DropPickupItem( Level.GetPlayer(), false );
     --end
     
     --if (Level.PlayerSuitcase == true) then
        --Actor.DropPickupItem( Level.GetPlayer(), false );
     --end
     
     --Level.InstallDpc("Level.SetHudFadeOut(1)", 1.0);
     
     --Level.LockPlayer(true);
     
     --Level.InstallDpc("Level.OnTeleportPlayer()", 2.5);
     --Level.InstallDpc("Level.OnBeginExplosion()", 3.0);

     Level.NeedSetHudFadeIn = true;
     Level.SetHudFadeOut(1.0);
          
     Level.LockPlayer(true);
     
     Level.Enable("saving", false );
     Level.Enable("gamemenu",false);
     
     if (tm == nil) then
        Level.InstallDpc("Level.OnBeginExplosionCutScene()", 1.0 );
     else
        if (tm > 0.0) then
           Level.InstallDpc("Level.OnBeginExplosionCutScene()", tm );
        else
           Level.OnBeginExplosionCutScene();
        end
     end
  end

--------------------------------------------------------
-- Name: Level.OnBeginExplosionCutScene()
-- Desc:
--------------------------------------------------------
function Level.OnBeginExplosionCutScene()

  if (Level.NeedSetHudFadeIn == true) then
      Level.SetHudFadeIn(0.5);
      Level.NeedSetHudFadeIn = false;
  end
     
  Level.Enable("saving", true );
  Level.Enable("gamemenu", true );
  
  Actor.SetTransform( Level.GetPlayer(), 504.17468, 107.73862, -1254.67908, -65.09862 );
  
  AI.RemoveSoundFader('SPRF');
 
  local t = 15.0;
    
  if ( Level.PlayerSuitcase == true ) then
  
     Actor.DropPickupItem( Level.GetPlayer(), false );
     
     t = 1.5;
          
  elseif (Level.PlayerKanistra == true) then
  
     local item = Actor.GetPickupItem( Level.GetPlayer() );
     if ( item != nil ) then
        Level.HideDropEntity = Entity.GetUniqueIDAsString( item );     
     end;
             
     Actor.DropPickupItem( Level.GetPlayer(), true );
     Level.StartPlayerCustomAnim( "Stand_Pickup_PetrolFlow" , 0, true, true, 'BEXP', false );
     
     Level.OnlyFire = true;
     
  elseif ( Level.PlayerGasBalon == true ) then
  
     local item = Actor.GetPickupItem( Level.GetPlayer() );
     if ( item != nil ) then
        Level.HideDropEntity = Entity.GetUniqueIDAsString( item );     
     end;
     
     Actor.DropPickupItem( Level.GetPlayer(), true );
     Level.StartPlayerCustomAnim( "Stand_Pickup_OpenGasbalon" , 0, true, true, 'BEXG', false );
     
  end;
      
  Level.BeginCutScene("StartExplosion", "Levels\\Cowboy\\StartExplosion.scm", "", t, { 3, 0.0, 40.0, 70.0, 255 } );
  
end;

--------------------------------------------------------
-- Name: Level.OnBeginExplosion()
-- Desc:
--------------------------------------------------------
  function Level.OnBeginExplosion()
     
     if ( Level.OnlyFire != false ) then
       Level.HideWorldObject('EJAZ');
       Level.HideWorldObject('GL11');
       --Level.ExplodeRoomGlass();
     end;
     
     Level.InstallDpc("Level.DoExplosionEffect()", 1.0);
          
     -- finish task
     Level.InstallDpc("Level.FinishTask('FIRE')", 5.0);
     Level.InstallDpc("Level.CanDisableExplosion=true", 2.0 );
     
     if (Level.NeedSetHudFadeIn == true) then
        Level.SetHudFadeIn(1);
     end
     
     -- Teleport player..
     
     -- check actor nearest pos:
     local playerRoomId = AI.GetPlayerRoom();
     local pos = Level.GetEntityPosition(Level.GetPlayer());

     if (playerRoomId == Level.GetRoom('VA62') or
         playerRoomId == Level.GetRoom('VA63')) then
     
        Actor.SetTransform( Level.GetPlayer(), 537.88318, 107.93862, -1183.3136, 120.62833 );
     
     elseif (Level.IsAtBBox({565.8862,107.5943,-1253.7545,586.1055,117.8728,-1234.7535}, pos)) then
     
        Actor.SetTransform( Level.GetPlayer(), 591.90948, 107.97973, -1240.42102, 88.40468 );
        
     end
     
     Level.LockPlayer(false);
     Level.BeginCutScene("Explosion", "Levels\\Cowboy\\Explosion.scm", "", 8.0, { 1, 0.0, 120.0, 200.0, 255 } );
     
     Level.InstallDpc("Level.DoAiExplosionReaction()", 3.0);
     
     local doors = { 'DR08', 'DR15' };
     for i in doors do
        local door = Level.FindDoor(doors[i]);
        if (door != nil) then
           Level.CloseDoor( door, true, Level.GetPlayer() );
           Level.SetDoorLocked( door, true, true );
           Level.SetDoorUnlockKey(door, "deadlock");
           AI.RegisterClosedDoor( door, true );           
        end
     end
     
     if (Level.Door08Closed == false) then
        Level.Door08Closed = true;
        AI.AddScriptDynamicObstacle( 'DR08', 565.0493, 107.7541, -1251.6084, 567.2475, 132.7541, -1236.6084);
     end
     
     AI.AddScriptDynamicObstacle('DR15', 525.5402, 107.7541, -1216.1741, 540.5402, 132.7541, -1213.9758);     
  end

--------------------------------------------------------
-- Name: Level.DoAiExplosionReaction()
-- Desc:
--------------------------------------------------------
  function Level.DoAiExplosionReaction()
     Level.AddMusic( Level.MUSIC_MOOD_ATTENTION, "#0.75#sounds\\music\\sustain.ogg" );       
     AI.SetAttention(AI.AI_TARGET_FORM, "Fbi", AI.ATTENTION_ALARM, true);
     AI.DisableDecamouflageMethod(AI.METHOD_COMBAT_SOUND, 25.0);
     AI.AddSound( AI.SOUND_TYPE_SHOOTING, 400.0, 515.13, 115.89, -1193.98)
  end

--------------------------------------------------------
-- Name: Level.EnableFireSound()
-- Desc:
--------------------------------------------------------
  function Level.EnableFireSound()
       
     Level.EnableSound( 'Fire', true );
     Level.EnableSound( 'Fire01', true );
     Level.EnableSound( 'Fire02', true );
  end

--------------------------------------------------------
-- Name: Level.ExplodeRoomGlass()
-- Desc:
--------------------------------------------------------
function Level.ExplodeRoomGlass()
  local glass = Level.FindWorldObject('GL11');
  if (glass != nil and Level.IsWorldObjectExploded(glass) != true) then
       Level.ExplodeWorldObject(glass);
  else
     print("Can't find object GL11");
  end     
end;

--------------------------------------------------------
-- Name: Level.DoExplosionEffect()
-- Desc:
--------------------------------------------------------
  function Level.DoExplosionEffect()
  
     Level.PlayEffect( "levels\\cowboy\\fire_window.sef" , 496.19287, 117.08772, -1240.70251, 0.0, -68.36087, 0.0 );
     Level.ExplosionDone = true;
          
     if (Level.OnlyFire == false) then
        Level.PlayEffect( "levels\\cowboy\\explosion.sef" , 483.72287, 121.69825, -1236.26929, 0.0, 0.0, 0.0 );
     end
               
     if (Level.OnlyFire == false) then        
        --print('LevelOnlyFire == ' .. tostring( Level.OnlyFire ) );
        Level.PlayCustomSound('Dynamite');
     end
     
     Level.InstallDpc("Level.EnableFireSound()", 2.0);
     
     if (Level.OnlyFire == false) then
        Level.HideWorldObject( 'RAM1' );
        Level.HideWorldObject( 'RAM2' );
        Level.ShowWorldObject( 'RAMA' );
     
        local rama = Level.FindWorldObject('RAMA');
        if (rama != nil) then
           Level.AddWorldObjectPhysicsForce(rama, -6200.0, 3800.0, 0.0 );
           --Level.AddWorldObjectPhysicsMoment(rama, -400.0, 0.0, 800.0 );
           Level.AddWorldObjectPhysicsMoment(rama, -400.0, 0.0, 800.0 );
        else
           print("Can't find object RAMA");
        end
     
        local objects = { 'PRT1', 'PRT2', 'PRT3',
                          'PRT4', 'PRT5', 'PRT6', 'PRT7' };
     
        local prop = {};

        prop['PRT1'] = { rx = 166.99, rz = 3.9094, ry = 0.0 };
        prop['PRT2'] = { rx = -34.585, rz = -65.899, ry = 0.0 };
        prop['PRT3'] = { rx = 89.148, rz = -225.14, ry = 0.0 };

        prop['PRT4'] = { rx = 1000.4499, rz = 1000.39094, ry = 1000.0 };
        prop['PRT5'] = { rx = -1000.534585, rz = -1000.6899, ry = 1000.0 };
        prop['PRT6'] = { rx = 1000.43148, rz = -1000.314, ry = 1000.0 };
        prop['PRT7'] = { rx = 1000.3148, rz = -1000.214, ry = 1000.0 };

        local force = {};
        force['PRT1'] = {x = -2890.0, y = 1859.4, z = -1600.0};
        force['PRT2'] = {x = -2680.0, y = 652.1, z = 200.0};
        force['PRT3'] = {x = -2410.0, y = 1589.5, z = -500.0};

        force['PRT4'] = {x = -3000.0, y = 1859.4, z = -600.0};
        force['PRT5'] = {x = -2500.0, y = 692.1, z = -800.0};
        force['PRT6'] = {x = -2870.0, y = 1589.5, z = 1000.0};
        force['PRT7'] = {x = -3200.0, y = 1423.5, z = -1500.0};
     
        --prop = nil;
     
        for i in objects do
           Level.ShowWorldObject( objects[i] );

           local object = Level.FindWorldObject(objects[i]);
           if (object != nil) then
           
              local y, rx, rz, ry;
           
              if (prop == nil or prop[objects[i]] == nil) then
                 rx = (Random() * 2.0 - 1.0) * 300.0;
                 rz = (Random() * 2.0 - 1.0) * 300.0;
                 ry = 0.0;
                 print(objects[i] .. " y = " .. tostring(y) .. ", rx = " .. tostring(rx) .. ", rz = " .. tostring(rz));
              else
                 rx = prop[objects[i]].rx;
                 rz = prop[objects[i]].rz;
                 ry = prop[objects[i]].ry;
              end
           
              local fx = -4500.0;
              local fz = -500.0;
              local fy = 1000.0
              if (force != nil and force[objects[i]] != nil) then
                 fx = force[objects[i]].x;
                 fz = force[objects[i]].z;
                 fy = force[objects[i]].y;
              end
           
              Level.AddWorldObjectPhysicsForce(object, fx, fy, fz );
              Level.AddWorldObjectPhysicsMoment(object, rx, ry, rz );
           else
              print("Can't find object " .. objects[i]);
           end
        end
     end
     
     if (Level.OnlyFire == false) then
       Level.ExplodeRoomGlass();
       Level.HideWorldObject('EJAZ');
     else
       --Level.InstallDpc( "Level.ExplodeRoomGlass()", 0.75 );     
     end;
              
          
     if (Level.OnlyFire == false) then
        Level.InstallDpc("Level.RestoreRamaPos()", 4.0);     
     end
  end

--------------------------------------------------------
-- Name: Level.CanStartFireCutScene()
-- Desc:
--------------------------------------------------------
  function Level.CanStartFireCutScene()
     return Level.CanStartFireCutSceneNoItemCheck() == true and
            (Level.PlayerSuitcase == true or Level.PlayerKanistra == true or Level.PlayerGasBalon == true);
  end

--------------------------------------------------------
-- Name: Level.CanStartFireCutScene()
-- Desc:
--------------------------------------------------------
  function Level.CanStartFireCutSceneNoItemCheck()
     return Level.IsMissionTaskCompleted('BODY') == true and 
            Level.IsMissionTaskCompleted('RESC') == true and 
            Level.IsMissionTaskCompleted('FIRE') == false and
            Level.HasMissionTask('FIRE') == true and
            AI.HasPlayerInfo("Fbi", "knowposition") == false;
  end
  
--------------------------------------------------------
-- Name: Level.CanStartFireCutScene()
-- Desc:
--------------------------------------------------------
  function Level.CanStartFireCutScene_Complex( itemCheck, knowPositionCheck )
     if (itemCheck == true) then
        if (Level.PlayerSuitcase == false and 
            Level.PlayerKanistra == false and 
            Level.PlayerGasBalon == false) then
           return false; 
        end
     end
     
     if (knowPositionCheck == true) then
        if (AI.HasPlayerInfo("Fbi", "knowposition") == true) then
           return false;
        end
     end
     
     return Level.IsMissionTaskCompleted('BODY') == true and 
            Level.IsMissionTaskCompleted('RESC') == true and 
            Level.IsMissionTaskCompleted('FIRE') == false and
            Level.HasMissionTask('FIRE') == true;
  end
  
  -------------------------- Old ------------------------

--------------------------------------------------------
-- Name: Level.OnAnchor_GetBoard()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_GetBoard()
     Level.UpdateBoard(1);
  end

--------------------------------------------------------
-- Name: Level.OnChangeBoardCamera()
-- Desc:
--------------------------------------------------------
  function Level.OnChangeBoardCamera(state)
     if (state == 1) then
        Level.ChangeCamCutScene( "Board", "Levels\\Cowboy\\GuardsBoard.scm", { 3, -10, 80.0, 200.0, 255 } );
     else
        Level.ChangeCamCutScene( "Board", "Levels\\Cowboy\\BalkonBoard.scm", { 1, 0, 120.0, 200.0, 255 } );
     end
  end

--------------------------------------------------------
-- Name: Level.OnInitAnchor_GetBoard()
-- Desc:
--------------------------------------------------------
  function Level.OnInitAnchor_GetBoard()
     Level.BeginCutScene("Board", "Levels\\Cowboy\\GetBoard.scm", "", 7.0 + 6.0 + 5.0, { 1, 0.0, 70.0, 100.0, 255 } );
     --Level.InstallDpc("Level.OnChangeBoardCamera(1)", 6.0);
     --Level.InstallDpc("Level.OnChangeBoardCamera(2)", 14.0);
     
     Level.InstallDpc("Level.OnChangeBoardCamera(2)", 6.0);
  end

--------------------------------------------------------
-- Name: Level.OnMoveBot()
-- Desc:
--------------------------------------------------------
  function Level.OnMoveBot()
     local spy = AI.FindNPC('FSPY');
     if (spy != nil) then
        local n = Entity.GetNode( AI.GetActor(spy) );

        node.SetPosition( n, 454.50873, 117.9565, -1191.3778 );
        node.InvalidateTransforms( n , true );
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_UseBoard()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_UseBoard()
     local spy = AI.FindNPC('FSPY');
     if (spy != nil) then
        AI.DirtyMove(spy, 454.50873, 117.9565, -1191.3778);
        
        Level.SetHudFadeOut(0.5);
        Level.InstallDpc("Level.SetHudFadeIn(0.5)", 2.0);
        Level.InstallDpc("Level.OnMoveBot()", 0.5);
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor262()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor262()
     local policeman = AI.FindNPC('PL10');
     local prop = {};
     prop["CustomString_1"] = 'A263';
     prop["CustomString_2"] = 'A264';

     AI.SetJob("alive", "linealert");
     
     AI.RunScriptTask(policeman, "scripts:job\\AnchorJob2_safe_run_firepolatt.lua", AI.LOGIC_DEFAULT, Level.ToCustomParams(prop));
     
     AI.EnableZone( "House3LineAlarm", true );
  end

--------------------------------------------------------
-- Name: Level.ExplodeItem()
-- Desc:
--------------------------------------------------------
function Level.ExplodeItem( item, px, py, pz)
   Level.DeleteItem( item );
   Level.CreateExplosion( px, py, pz );
end

--------------------------------------------------------
-- Name: Level.DoKillActor()
-- Desc:
--------------------------------------------------------
function Level.DoKillActor(entity)
   -- check is entity actor?
   if (Actor.IsActor(entity) == false) then
      return;
   end

   if (Actor.IsDead(entity) == true) then
      if (Actor.IsHitted(entity) == false) then
         return;
      else
         local npc = AI.FromActor( entity );

         if (AI.GetForm(npc) == "Fbi" or AI.GetForm(npc) == "Policeman") then
             Level.GuardsHittedBeforeExplosion   = Level.GuardsHittedBeforeExplosion + 1;
         else
             Level.CivilianHittedBeforeExplosion = Level.CivilianHittedBeforeExplosion + 1;
         end
      end
   end

   local npc = AI.FromActor( entity );
   
   if (AI.GetForm(npc) == "Fbi" or AI.GetForm(npc) == "Policeman") then
      Level.GuardsKilledByExplosion = Level.GuardsKilledByExplosion + 1;
   else
      Level.CivilianKilledByExplosion = Level.CivilianKilledByExplosion + 1;
   end
   
   if (npc != nil) then
      AI.KillNPC(npc, 0.0);
   end
end

--------------------------------------------------------
-- Name: Level.KillAllAtRoom()
-- Desc:
--------------------------------------------------------
function Level.KillAllAtRoom()
    Level.ForEachEntity("", "DoKillActor", 488.4804, 107.9977, -1310.8933, 558.4804, 127.9977, -1220.8933);
end

--------------------------------------------------------
-- Name: Level.OnHitItemBullet()
-- Desc:
--------------------------------------------------------
function Level.OnHitItemBullet( item, itemId, px, py, pz )
  
  if (Level.AtPutBodyTrigger == false) then
     if (Level.CanStartFireCutScene_Complex(false, false) == true) then

        if ( itemId == 'GB01' and Level.BalonAtRoom == true ) then
           Level.OnBeginExplosion();
           Level.KillAllAtRoom();
           return;
        end;
     
        if ( itemId == 'KN01' and Level.KanistraAtRoom == true ) then
           Level.OnBeginExplosion();
           Level.KillAllAtRoom();
           return;
        end;
     end
  end
  
  if ( itemId == 'GB01' or itemId == 'KN01') then
     Level.ExplodeItem( item, px, py, pz );
     
     if ( (itemId == 'KN01' and Level.KanistraAtRoom == true) or
          (itemId == 'GB01' and Level.BalonAtRoom == true)) then
          
          Level.KillAllAtRoom();
     end
  end
    
end;

--------------------------------------------------------
-- Name: Level.OnAnimScriptNotify()
-- Desc:
--------------------------------------------------------
function Level.OnAnimScriptNotify( actorUniqueId, animName, frame )
   if (animName == "Act_Cowboy_Spy1") then
      Level.UpdateBoard(1);
   end
end;

--------------------------------------------------------
-- Name: Level.OnFinalDeformationBotReaction()
-- Desc:
--------------------------------------------------------
function Level.OnFinalDeformationBotReaction()
   local npcId = { 'CW18', 'CW16' };
   local anchors = { {'A273'}, {'A274', 'A275'} };
   
   for i in npcId do
      local npc = AI.FindNPC(npcId[i]);
      if (AI.IsDefault(npc) == true) then
         if (table.getn(anchors[i]) == 1) then
            Level.RunAnchorJob_Run( npc, anchors[i][1], true );
         elseif (table.getn(anchors[i]) == 2) then 
            Level.RunAnchorJob2_Run( npc, anchors[i][1], anchors[i][2], true );
         end
      end
   end
end

--------------------------------------------------------
-- Name: Level.UpdateBoardDeformation()
-- Desc:
--------------------------------------------------------
function Level.UpdateBoardDeformation(id)
   if (Level.BoardState != 1) then
      return;
   end
   
   Level.BoardDeformation = id;
   
   if (id == 1) then
      Level.HideWorldObject( 'BRD2' );
      Level.ShowWorldObject( 'BRS1' );
      
      --Level.EnableSound( 'WoodCrash', true );
      --Level.InstallDpc( "Level.EnableSound( 'WoodCrash', false)", 2.0);
      Level.PlayCustomSound( 'WoodCrash' );

   elseif (id == 2) then
      Level.HideWorldObject( 'BRS1' );
      Level.ShowWorldObject( 'BRS2' );  
      
      --Level.EnableSound( 'WoodCrash', true );
      --Level.InstallDpc( "Level.EnableSound( 'WoodCrash', false)", 2.0);
      Level.PlayCustomSound( 'WoodCrash' );
      
   elseif (id == 3) then
      Level.HideWorldObject( 'BRS2' );
   
      local parts = { 'BRP1', 'BRP2' };
      for i in parts do
         Level.ShowWorldObject( parts[i] );
         
         local part = Level.FindWorldObject(parts[i]);
         if (part != nil) then
            Level.EnableWorldObjectPhysics( part );
         else
            print("Can't find object " .. parts[i]);
         end
      end
      
      Level.PlayCustomSound( 'WoodCrashFinal' );
      
      Level.InstallDpc("Level.OnFinalDeformationBotReaction()", 2.0);
   end
end

--------------------------------------------------------
-- Name: Level.NextBoardDeformation()
-- Desc:
--------------------------------------------------------
function Level.NextBoardDeformation()
   if (Level.BoardState != 1) then
      return;
   end
   
   if ( Level.BoardDeformation == 1 ) then
     local doDeform = true;
     
     if ( Level.GetDifficulty() == 0 ) then
        doDeform = false;     
     elseif ( Level.IsMissionTaskCompleted('BODY') == false and Actor.HasPickupedActor( Level.GetPlayer() ) == false ) then
        doDeform = false;     
     end;
          
     if ( doDeform == false ) then
       Level.UpdateBoardDeformation(Level.BoardDeformation);
       return;     
     end;
     
   end;
      
   if (Level.BoardDeformation >= 3) then
      return;
   end
   
   if ( Level.BoardDeformation == 1 ) then
   
     Level.HideWorldObject( 'BRS1' );
     Level.ShowWorldObject( 'BRDA' );      
     Level.EnableWorldObjectAnim( Level.FindWorldObject('BRDA'), true, 5.0, 15.0, 30.0, 5.0, false );
         
     Level.PlayCustomSound( 'WoodCrashFinal' );
      
     Level.BeginCutScene("BoardDeform", "Levels\\Cowboy\\DoskaBroke.scm", "", 2.0, { 3, -40.0, 20.0, 40.0, 255 } );  
   else
     Level.UpdateBoardDeformation(Level.BoardDeformation + 1);
   end;
end

--------------------------------------------------------
-- Name: Level.BarrelsSmokePause()
-- Desc:
--------------------------------------------------------
function Level.OnBarrelsAccidentSmokePause( floor )
   if (floor == 2) then
      Level.RunAnchorJob_Run( AI.FindNPC('CW07'), 'A268', true);
      Level.RunAnchorJob_Run( AI.FindNPC('CW08'), 'A269', true);
      Level.RunAnchorJob_Run( AI.FindNPC('CW15'), 'A270', true);
      Level.RunAnchorJob_Run( AI.FindNPC('CW06'), 'A271', true);
      
      Level.RunAnchorJob( AI.FindNPC('CW14'), 'A272', true);
   elseif (floor == 1) then
      local workers = { 'CW02', 'CW03', 'CW04', 'CW05' };
      for i in workers do
         local worker = AI.FindNPC(workers[i]);
         if (worker != nil) then
            NPC.DoDropItem( worker, true );
            AI.SetJob(worker, "relax");
         end
      end
   end
   
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor214()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor214()
   Level.OnBarrelsAccidentSmokePause( 2 );
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor213()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor213()
   Level.OnBarrelsAccidentSmokePause( 1 );
end

--------------------------------------------------------
-- Name: Level.OnChangeFbiCloth()
-- Desc:
--------------------------------------------------------
function Level.OnChangeFbiCloth()
    
   local player = Level.GetPlayer();
   if ( player != nil ) then
     Actor.EnableMesh( player, "mesh_hat"     , false );
     --Actor.EnableMesh( player, "mesh_glasses" , false );     
   end;

end;

--------------------------------------------------------
-- Name: Level.OnDoMadamJob()
-- Desc:
--------------------------------------------------------
function Level.OnDoMadamJob()
   local npc = AI.FindNPC('T208');
   
   if (AI.IsDefault(npc) == false) then
      return;
   end
   
   if (Level.KabinetDroped == true) then
      return;
   end
   
   if (Level.GetDifficulty() == 0) then
      Level.RunAnchorJob3(npc, 'A265', 'A278', 'A254', true);
   else
      Level.RunAnchorJob(npc, 'A249', true);
   end
end

--------------------------------------------------------
-- Name: Level.HackRestart()
-- Desc:
--------------------------------------------------------
function Level.HackRestart()
   AI.EnableZone("ChWorkerFbiZone", false);
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor_A228()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor_A228()
   -- Level.InstallDpc("AI.HandleVoice(AI.FindNPC('ML01'), 'male_rus_ohers_pider')", 1.0);
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor_267()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor_267()
   local npc = AI.FindNPC('PL10');
   if (AI.IsDefault(npc) == true) then
      AI.HandleVoice(AI.FindNPC('ML01'), "male_usa_script_script_39");
      Level.RunAnchorJob(AI.FindNPC('PL10'), 'A228', false);
   end
end

--------------------------------------------------------
-- Name: Level.OnTransformStats()
-- Desc:
--------------------------------------------------------
function Level.OnTransformStats(levelStats, aiStats)
   if (Level.AgentHitted == true) then
      Level.DecrementLevelStats(levelStats, "NumCivilianStuned");
   end
   
   local actor = Level.FindActor('FB30');

   if (Actor.IsDead(actor) == false and Actor.IsHitted(actor) == true) then
      Level.DecrementLevelStats(levelStats, "NumEnemiesStuned");
   end
   
   if (Level.GuardsKilledByExplosion > 0) then
      Level.ChangeLevelStats(levelStats, "NumEnemiesKilled", Level.GuardsKilledByExplosion);
   end
   
   if (Level.CivilianKilledByExplosion > 0) then
      Level.ChangeLevelStats(levelStats, "NumCivilianKilled", Level.CivilianKilledByExplosion);
   end
   
   if (Level.GuardsHittedBeforeExplosion > 0) then
      Level.ChangeLevelStats(levelStats, "NumEnemiesStuned", -Level.GuardsHittedBeforeExplosion);
   end

   if (Level.CivilianHittedBeforeExplosion > 0) then
      Level.ChangeLevelStats(levelStats, "NumCivilianStuned", -Level.CivilianHittedBeforeExplosion);
   end
end

--------------------------------------------------------
-- Name: Level.OnTransformStats()
-- Desc:
--------------------------------------------------------
function Level.OnTransformInputs(levelStats, aiStats, a, c, p, n, acc)
   c = c * 1.2;
   n = n * 0.9;
   
   local n_old = n;
   
   if (Level.IsMissionTaskCompleted('FIRE') == true) then
      if (Level.OnlyFire == false) then
         n = n + 0.5;
      else
         n = n + 0.2;
      end
   end
   
   if (Level.AgentHitted == true) then
      c = c + 0.1;
   end
  
   if (Level.GetDifficulty() == 3) then
      c = c * 0.3;
   end
   
   p = Level.DefaultCalcProf(c, n_old, acc);
  
   return a, c, p, n;
end

--------------------------------------------------------
-- Name: Level.OnCalcScore()
-- Desc:
--------------------------------------------------------
function Level.OnCalcRateScore(rank, score, levelStats, aiStats, a, c, p, n, acc)
   return rank, score;
end
